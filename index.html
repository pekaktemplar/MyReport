<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyReport</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply the Inter font to the whole application */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better visual appeal and to hide elements */
        .hidden-dialog {
            display: none;
        }
        /* Ensure charts don't shrink uncontrollably in a flex/grid container */
        .chart-container {
            position: relative;
            min-height: 250px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 font-sans text-gray-800 p-4 sm:p-6 md:p-8">

    <!-- Main Application Container -->
    <div id="app-container">
        <!-- Loading State -->
        <div id="loading-indicator" class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold text-gray-700">Memuat Aplikasi...</div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden-dialog items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full">
                <h1 class="text-3xl font-bold text-indigo-800 mb-2">MyReport</h1>
                <p class="text-gray-600 mb-6">Silakan login untuk melanjutkan</p>
                <button id="google-signin-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.19 4.223-4.243 5.571l6.252 5.218C41.91 35.778 44 30.551 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-display" class="hidden-dialog items-center justify-center min-h-screen bg-red-100 text-red-700 p-4 rounded-md">
            <p id="error-message" class="text-xl font-semibold text-center"></p>
        </div>

        <!-- Main Application Content (hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Header -->
            <header class="bg-white shadow-lg rounded-xl p-4 mb-8 flex flex-col sm:flex-row items-center justify-between">
                <h1 class="text-3xl font-bold text-indigo-800 mb-2 sm:mb-0">MyReport</h1>
                <div id="user-info" class="hidden-dialog items-center gap-3">
                    <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="User Photo">
                    <div class="text-sm">
                        <span id="user-name" class="font-semibold text-gray-800"></span>
                        <span id="user-email" class="text-gray-500"></span>
                    </div>
                    <button id="signout-btn" class="ml-4 bg-red-500 text-white py-2 px-3 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 text-sm">Sign Out</button>
                </div>
                <button id="export-excel-btn" class="mt-4 sm:mt-0 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Export Semua Data ke Excel
                </button>
            </header>

            <!-- Navigation Tabs -->
            <nav id="tabs-container" class="mb-8 bg-white shadow-md rounded-xl p-2 flex flex-wrap justify-center gap-2 sm:gap-4">
                <button data-tab="komplain" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 bg-indigo-600 text-white shadow-md">Komplain</button>
                <button data-tab="sla" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 text-indigo-700 hover:bg-indigo-100">SLA & Kinerja</button>
                <button data-tab="isu" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 text-indigo-700 hover:bg-indigo-100">Isu & Dukungan</button>
                <button data-tab="infoTambahan" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 text-indigo-700 hover:bg-indigo-100">Info Tambahan</button>
            </nav>

            <!-- Main Content Area -->
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Input Forms Column -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <!-- Complaint Form -->
                    <div id="form-komplain" class="tab-content">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- SLA Form -->
                    <div id="form-sla" class="tab-content hidden-dialog">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- Issue Form -->
                    <div id="form-isu" class="tab-content hidden-dialog">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- Additional Info Form -->
                    <div id="form-infoTambahan" class="tab-content hidden-dialog">
                        <!-- Content is generated by JavaScript -->
                    </div>
                </div>

                <!-- Display List Column -->
                <div class="lg:col-span-2">
                    <!-- Complaint Display -->
                    <div id="display-komplain" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- SLA Display -->
                    <div id="display-sla" class="tab-content hidden-dialog bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- Issue Display -->
                    <div id="display-isu" class="tab-content hidden-dialog bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- Content is generated by JavaScript -->
                    </div>
                    <!-- Additional Info Display -->
                    <div id="display-infoTambahan" class="tab-content hidden-dialog bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- Content is generated by JavaScript -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Dialogs -->
    <!-- Message Dialog -->
    <div id="message-dialog" class="hidden-dialog fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <p id="message-dialog-content" class="text-lg font-medium text-gray-800 mb-4"></p>
            <button id="message-dialog-ok-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">OK</button>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmation-dialog" class="hidden-dialog fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <p id="confirmation-dialog-content" class="text-lg font-medium text-gray-800 mb-4"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmation-dialog-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">Batal</button>
                <button id="confirmation-dialog-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">Konfirmasi</button>
            </div>
        </div>
    </div>

    <!-- Status Update Dialog -->
    <div id="status-update-dialog" class="hidden-dialog fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ubah Status</h3>
            <div class="mb-4">
                <label for="status-update-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Status Baru</label>
                <select id="status-update-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <!-- Options are generated by JavaScript -->
                </select>
            </div>
            <div id="status-update-completion-date-container" class="mb-4 hidden-dialog">
                <label for="status-update-completion-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                <input type="date" id="status-update-completion-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex justify-end gap-3">
                <button id="status-update-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">Batal</button>
                <button id="status-update-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs and Application Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE AND CONSTANTS ---
        let db, auth;
        let userId = null;
        let activeTab = 'komplain';
        let firestoreUnsubscribes = []; // To hold our listener cleanup functions

        // Data stores
        let allComplaints = [];
        let allSlaRecords = [];
        let allIssues = [];
        let allInfoTambahan = [];

        // Filter states
        let complaintPeriodFilter = 'Semua Periode';
        let slaPeriodFilter = 'Semua Periode';
        let issuePeriodFilter = 'Semua Periode';
        let infoTambahanPeriodFilter = 'Semua Periode';
        
        // UI State for visualizations
        let showComplaintsViz = false;
        let showSlaViz = false;
        let showIssuesViz = false;
        
        // Chart instances
        let complaintsStatusChart, complaintsBranchChart;
        let slaComplianceChart, slaStatusChart, slaBranchChart;
        let issuesStatusChart, issuesBranchChart;

        const branches = ['Mataram', 'Maluk', 'Bali', 'Surabaya', 'Yogyakarta', 'Semarang'];
        const statusOptions = ['Dalam Proses', 'Selesai'];
        const chartColors = ['#8884d8', '#82ca9d', '#ffc658', '#FF8042', '#0088FE', '#00C49F'];

        // --- DOM ELEMENT REFERENCES ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const loginScreen = document.getElementById('login-screen');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const userPhoto = document.getElementById('user-photo');
        const signOutBtn = document.getElementById('signout-btn');
        
        // Dialogs
        const messageDialog = document.getElementById('message-dialog');
        const messageDialogContent = document.getElementById('message-dialog-content');
        const messageDialogOkBtn = document.getElementById('message-dialog-ok-btn');
        const confirmationDialog = document.getElementById('confirmation-dialog');
        const confirmationDialogContent = document.getElementById('confirmation-dialog-content');
        const confirmationDialogCancelBtn = document.getElementById('confirmation-dialog-cancel-btn');
        const confirmationDialogConfirmBtn = document.getElementById('confirmation-dialog-confirm-btn');
        const statusUpdateDialog = document.getElementById('status-update-dialog');
        const statusUpdateSelect = document.getElementById('status-update-select');
        const statusUpdateCompletionDateContainer = document.getElementById('status-update-completion-date-container');
        const statusUpdateCompletionDate = document.getElementById('status-update-completion-date');
        const statusUpdateCancelBtn = document.getElementById('status-update-cancel-btn');
        const statusUpdateConfirmBtn = document.getElementById('status-update-confirm-btn');

        // --- UTILITY FUNCTIONS ---
        const formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getReportingPeriodDetails = (date = new Date()) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            const startDateStr = formatDate(monday);
            const endDateStr = formatDate(sunday);
            return {
                startDate: startDateStr,
                endDate: endDateStr,
                formattedPeriod: `${startDateStr} s/d ${endDateStr}`
            };
        };

        const formatReportingPeriod = (startDateStr, endDateStr) => {
            if (!startDateStr || !endDateStr) return '';
            return `${startDateStr} s/d ${endDateStr}`;
        };

        // --- DIALOG MANAGEMENT ---
        const showMessage = (message) => {
            messageDialogContent.textContent = message;
            messageDialog.classList.remove('hidden-dialog');
            messageDialog.classList.add('flex');
        };

        const hideMessage = () => {
            messageDialog.classList.add('hidden-dialog');
            messageDialog.classList.remove('flex');
        };

        const showConfirmation = (message, onConfirm) => {
            confirmationDialogContent.textContent = message;
            confirmationDialog.classList.remove('hidden-dialog');
            confirmationDialog.classList.add('flex');
            // Clone and replace the button to remove old event listeners
            const newConfirmBtn = confirmationDialogConfirmBtn.cloneNode(true);
            confirmationDialogConfirmBtn.parentNode.replaceChild(newConfirmBtn, confirmationDialogConfirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmation();
            });
        };
        
        const hideConfirmation = () => {
            confirmationDialog.classList.add('hidden-dialog');
            confirmationDialog.classList.remove('flex');
        };
        
        // --- RENDER FUNCTIONS ---
        
        // Helper to create input fields for forms
        const createFormElement = (id, name, label, type = 'text', options = {}) => {
            const { placeholder = '', value = '', rows = 3, required = false, selectOptions = [] } = options;
            const wrapper = document.createElement('div');
            const labelEl = document.createElement('label');
            labelEl.htmlFor = id;
            labelEl.className = "block text-sm font-medium text-gray-700 mb-1";
            labelEl.textContent = label;
            wrapper.appendChild(labelEl);

            let inputEl;
            if (type === 'select') {
                inputEl = document.createElement('select');
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `Pilih ${label}`;
                inputEl.appendChild(defaultOption);
                selectOptions.forEach(opt => {
                    const optionEl = document.createElement('option');
                    optionEl.value = opt;
                    optionEl.textContent = opt;
                    if (value === opt) optionEl.selected = true;
                    inputEl.appendChild(optionEl);
                });
            } else if (type === 'textarea') {
                inputEl = document.createElement('textarea');
                inputEl.rows = rows;
                inputEl.placeholder = placeholder;
                inputEl.textContent = value;
            } else {
                inputEl = document.createElement('input');
                inputEl.type = type;
                inputEl.placeholder = placeholder;
                inputEl.value = value;
                if (type === 'date') inputEl.className = "w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500";
            }
            
            inputEl.id = id;
            inputEl.name = name;
            inputEl.className = "w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500";
            if (options.readOnly) {
                inputEl.readOnly = true;
                inputEl.classList.add('bg-gray-50', 'focus:outline-none');
            }
            if (required) inputEl.required = true;

            wrapper.appendChild(inputEl);
            return wrapper;
        };

        const renderForms = () => {
            const period = getReportingPeriodDetails();
            
            // Complaint Form
            const formKomplain = document.getElementById('form-komplain');
            formKomplain.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Tambah Komplain Baru</h2>
                <div class="space-y-4">
                    ${createFormElement('compBranch', 'branch', 'Cabang', 'select', { selectOptions: branches }).outerHTML}
                    ${createFormElement('compPeriodStartDate', 'periodStartDate', 'Mulai Periode Pelaporan', 'date', { value: period.startDate }).outerHTML}
                    ${createFormElement('compPeriodEndDate', 'periodEndDate', 'Akhir Periode Pelaporan', 'date', { value: period.endDate }).outerHTML}
                    ${createFormElement('compReportingPeriodDisplay', 'reportingPeriodDisplay', 'Periode Pelaporan (Terbentuk)', 'text', { value: period.formattedPeriod, readOnly: true }).outerHTML}
                    ${createFormElement('compTitle', 'title', 'Judul Komplain', 'text', { placeholder: 'Antrian panjang di kasir' }).outerHTML}
                    ${createFormElement('compDesc', 'description', 'Deskripsi Detail', 'textarea', { placeholder: 'Pasien mengeluhkan antrian yang sangat panjang...' }).outerHTML}
                    ${createFormElement('compHandling', 'handling', 'Tindakan Penanganan', 'textarea', { placeholder: 'Sudah dilakukan penambahan staf...' }).outerHTML}
                    ${createFormElement('compStatus', 'status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' }).outerHTML}
                    <button id="add-complaint-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Tambah Komplain</button>
                </div>
            `;

            // SLA Form
            const formSla = document.getElementById('form-sla');
            formSla.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Tambah Catatan SLA</h2>
                <div class="space-y-4">
                    ${createFormElement('slaBranch', 'branch', 'Cabang', 'select', { selectOptions: branches }).outerHTML}
                    ${createFormElement('slaPeriodStartDate', 'periodStartDate', 'Mulai Periode Pelaporan', 'date', { value: period.startDate }).outerHTML}
                    ${createFormElement('slaPeriodEndDate', 'periodEndDate', 'Akhir Periode Pelaporan', 'date', { value: period.endDate }).outerHTML}
                    ${createFormElement('slaReportingPeriodDisplay', 'reportingPeriodDisplay', 'Periode Pelaporan (Terbentuk)', 'text', { value: period.formattedPeriod, readOnly: true }).outerHTML}
                    
                    <!-- On Clinic Section -->
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-2">
                        <h3 class="text-lg font-semibold text-indigo-700">Layanan On Clinic</h3>
                        ${createFormElement('onClinicJumlahSesuai', 'onClinic.jumlahSesuai', 'Jumlah Sesuai SLA', 'number', { value: 0 }).outerHTML}
                        ${createFormElement('onClinicJumlahTidakSesuai', 'onClinic.jumlahTidakSesuai', 'Jumlah Tidak Sesuai SLA', 'number', { value: 0 }).outerHTML}
                        ${createFormElement('onClinicPenyebab', 'onClinic.penyebab', 'Penyebab', 'textarea', { rows: 2, placeholder: 'Kekurangan dokter...' }).outerHTML}
                        ${createFormElement('onClinicPenanganan', 'onClinic.penanganan', 'Penanganan', 'textarea', { rows: 2, placeholder: 'Rekrutmen dokter baru...' }).outerHTML}
                        ${createFormElement('onClinicStatus', 'onClinic.status', 'Status Penanganan', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' }).outerHTML}
                    </div>
                    
                    <!-- On Site Section -->
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-2">
                        <h3 class="text-lg font-semibold text-indigo-700">Layanan On Site</h3>
                         ${createFormElement('onSiteJumlahSesuai', 'onSite.jumlahSesuai', 'Jumlah Sesuai SLA', 'number', { value: 0 }).outerHTML}
                        ${createFormElement('onSiteJumlahTidakSesuai', 'onSite.jumlahTidakSesuai', 'Jumlah Tidak Sesuai SLA', 'number', { value: 0 }).outerHTML}
                        ${createFormElement('onSitePenyebab', 'onSite.penyebab', 'Penyebab', 'textarea', { rows: 2, placeholder: 'Kendala transportasi...' }).outerHTML}
                        ${createFormElement('onSitePenanganan', 'onSite.penanganan', 'Penanganan', 'textarea', { rows: 2, placeholder: 'Pengadaan kendaraan...' }).outerHTML}
                        ${createFormElement('onSiteStatus', 'onSite.status', 'Status Penanganan', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' }).outerHTML}
                    </div>
                    
                    <button id="add-sla-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Tambah Catatan SLA</button>
                </div>
            `;
            
            // Issue Form
            const formIsu = document.getElementById('form-isu');
            formIsu.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Tambah Isu Baru</h2>
                <div class="space-y-4">
                    ${createFormElement('issueBranch', 'branch', 'Cabang', 'select', { selectOptions: branches }).outerHTML}
                    ${createFormElement('issuePeriodStartDate', 'periodStartDate', 'Mulai Periode Pelaporan', 'date', { value: period.startDate }).outerHTML}
                    ${createFormElement('issuePeriodEndDate', 'periodEndDate', 'Akhir Periode Pelaporan', 'date', { value: period.endDate }).outerHTML}
                    ${createFormElement('issueReportingPeriodDisplay', 'reportingPeriodDisplay', 'Periode Pelaporan (Terbentuk)', 'text', { value: period.formattedPeriod, readOnly: true }).outerHTML}
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 space-y-2">
                        <h3 class="text-lg font-semibold text-indigo-700">Detail Isu</h3>
                        ${createFormElement('issueDesc', 'issueDescription', 'Deskripsi Isu', 'textarea', { placeholder: 'Mesin USG sering rusak...' }).outerHTML}
                        ${createFormElement('issueSupport', 'supportRequest', 'Permintaan Dukungan', 'textarea', { placeholder: 'Butuh alokasi dana...' }).outerHTML}
                        ${createFormElement('issueStatus', 'status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' }).outerHTML}
                    </div>
                    <button id="add-issue-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Tambah Isu</button>
                </div>
            `;
            
            // Info Tambahan Form
            const formInfoTambahan = document.getElementById('form-infoTambahan');
            formInfoTambahan.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Tambah Info Baru</h2>
                <div class="space-y-4">
                    ${createFormElement('infoBranch', 'branch', 'Cabang', 'select', { selectOptions: branches }).outerHTML}
                    ${createFormElement('infoPeriodStartDate', 'periodStartDate', 'Mulai Periode Pelaporan', 'date', { value: period.startDate }).outerHTML}
                    ${createFormElement('infoPeriodEndDate', 'periodEndDate', 'Akhir Periode Pelaporan', 'date', { value: period.endDate }).outerHTML}
                    ${createFormElement('infoReportingPeriodDisplay', 'reportingPeriodDisplay', 'Periode Pelaporan (Terbentuk)', 'text', { value: period.formattedPeriod, readOnly: true }).outerHTML}
                    ${createFormElement('infoField', 'info', 'Info', 'textarea', { rows: 5, value: '• ', placeholder: '• Masukkan poin info...' }).outerHTML}
                    <button id="add-info-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Tambah Info</button>
                </div>
            `;
            
            // Add event listeners after rendering
            addFormEventListeners();
        };
        
        const renderAllTabs = () => {
            renderComplaintsTab();
            renderSlaTab();
            renderIssuesTab();
            renderInfoTambahanTab();
        };

        const renderComplaintsTab = () => {
            const container = document.getElementById('display-komplain');
            const uniquePeriods = ['Semua Periode', ...new Set(allComplaints.map(c => c.reportingPeriod))].sort();
            const filteredData = complaintPeriodFilter === 'Semua Periode' ? allComplaints : allComplaints.filter(c => c.reportingPeriod === complaintPeriodFilter);
            const vizContainerClass = showComplaintsViz ? '' : 'hidden-dialog';
            const vizButtonText = showComplaintsViz ? 'Sembunyikan Visualisasi' : 'Tampilkan Visualisasi';
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Daftar Komplain</h2>
                <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center">
                        <label for="compPeriodFilter" class="block text-sm font-medium text-gray-700">Filter Periode</label>
                        <select id="compPeriodFilter" class="ml-3 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            ${uniquePeriods.map(p => `<option value="${p}" ${p === complaintPeriodFilter ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </div>
                    <button id="toggle-complaints-viz" class="px-3 py-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-200 flex items-center gap-1">
                        ${vizButtonText}
                    </button>
                </div>
                <div id="complaints-viz-container" class="${vizContainerClass} grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border"><h3 class="text-xl font-semibold text-indigo-700 mb-3 text-center">Komplain per Status</h3><div class="chart-container"><canvas id="complaints-status-chart"></canvas></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border"><h3 class="text-xl font-semibold text-indigo-700 mb-3 text-center">Komplain per Cabang</h3><div class="chart-container"><canvas id="complaints-branch-chart"></canvas></div></div>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                    ${filteredData.length === 0 ? '<p class="text-gray-500 p-4">Belum ada data.</p>' : `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cabang</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Judul</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Selesai</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filteredData.map(c => `
                            <tr data-id="${c.id}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${c.branch}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${c.title}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${c.status === 'Selesai' ? 'text-green-600' : 'text-blue-600'}">${c.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${c.completionDate || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex gap-2">
                                        <button class="status-update-btn text-indigo-600 hover:text-indigo-900" data-type="complaint" data-status="${c.status}">Ubah Status</button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-type="complaint">Hapus</button>
                                    </div>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                </div>
            `;
            if (showComplaintsViz) {
                renderComplaintsCharts(filteredData);
            }
        };

        const renderSlaTab = () => {
            const container = document.getElementById('display-sla');
            const uniquePeriods = ['Semua Periode', ...new Set(allSlaRecords.map(s => s.reportingPeriod))].sort();
            const filteredData = slaPeriodFilter === 'Semua Periode' ? allSlaRecords : allSlaRecords.filter(s => s.reportingPeriod === slaPeriodFilter);
            const vizContainerClass = showSlaViz ? '' : 'hidden-dialog';
            const vizButtonText = showSlaViz ? 'Sembunyikan Visualisasi' : 'Tampilkan Visualisasi';
            
            container.innerHTML = `
                 <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Daftar Catatan SLA</h2>
                 <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center">
                        <label for="slaPeriodFilter" class="block text-sm font-medium text-gray-700">Filter Periode</label>
                        <select id="slaPeriodFilter" class="ml-3 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            ${uniquePeriods.map(p => `<option value="${p}" ${p === slaPeriodFilter ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </div>
                    <button id="toggle-sla-viz" class="px-3 py-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-200 flex items-center gap-1">
                       ${vizButtonText}
                    </button>
                </div>
                <div id="sla-viz-container" class="${vizContainerClass} bg-gray-50 p-4 rounded-lg shadow-inner mb-6 border">
                    <!-- Charts will be rendered here -->
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                     ${filteredData.length === 0 ? '<p class="text-gray-500 p-4">Belum ada data.</p>' : `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cabang</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">On Clinic (Status)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">On Site (Status)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                             ${filteredData.map(s => `
                            <tr data-id="${s.id}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${s.branch}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${s.onClinic.status === 'Selesai' ? 'text-green-600' : 'text-blue-600'}">${s.onClinic.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${s.onSite.status === 'Selesai' ? 'text-green-600' : 'text-blue-600'}">${s.onSite.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex flex-col gap-2">
                                        <button class="status-update-btn text-blue-600 hover:text-blue-900" data-type="sla" data-subservice="onClinic" data-status="${s.onClinic.status}">Ubah Status On Clinic</button>
                                        <button class="status-update-btn text-blue-600 hover:text-blue-900" data-type="sla" data-subservice="onSite" data-status="${s.onSite.status}">Ubah Status On Site</button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-type="sla">Hapus</button>
                                    </div>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                </div>
            `;
            if (showSlaViz) {
                renderSlaCharts(filteredData);
            }
        };
        
        const renderIssuesTab = () => {
            const container = document.getElementById('display-isu');
            const uniquePeriods = ['Semua Periode', ...new Set(allIssues.map(i => i.reportingPeriod))].sort();
            const filteredData = issuePeriodFilter === 'Semua Periode' ? allIssues : allIssues.filter(i => i.reportingPeriod === issuePeriodFilter);
            const vizContainerClass = showIssuesViz ? '' : 'hidden-dialog';
            const vizButtonText = showIssuesViz ? 'Sembunyikan Visualisasi' : 'Tampilkan Visualisasi';
            
            container.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Daftar Isu & Dukungan</h2>
                <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center">
                        <label for="issuePeriodFilter" class="block text-sm font-medium text-gray-700">Filter Periode</label>
                        <select id="issuePeriodFilter" class="ml-3 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            ${uniquePeriods.map(p => `<option value="${p}" ${p === issuePeriodFilter ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </div>
                    <button id="toggle-issues-viz" class="px-3 py-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-200 flex items-center gap-1">
                        ${vizButtonText}
                    </button>
                </div>
                <div id="issues-viz-container" class="${vizContainerClass} grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border"><h3 class="text-xl font-semibold text-indigo-700 mb-3 text-center">Isu per Status</h3><div class="chart-container"><canvas id="issues-status-chart"></canvas></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border"><h3 class="text-xl font-semibold text-indigo-700 mb-3 text-center">Isu per Cabang</h3><div class="chart-container"><canvas id="issues-branch-chart"></canvas></div></div>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                    ${filteredData.length === 0 ? '<p class="text-gray-500 p-4">Belum ada data.</p>' : `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cabang</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Selesai</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                             ${filteredData.map(i => `
                            <tr data-id="${i.id}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${i.branch}</td>
                                <td class="px-6 py-4 text-sm max-w-xs truncate">${i.issueDescription}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${i.status === 'Selesai' ? 'text-green-600' : 'text-blue-600'}">${i.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${i.completionDate || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex gap-2">
                                        <button class="status-update-btn text-indigo-600 hover:text-indigo-900" data-type="issue" data-status="${i.status}">Ubah Status</button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-type="issue">Hapus</button>
                                    </div>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                </div>
            `;
            if (showIssuesViz) {
                renderIssuesCharts(filteredData);
            }
        };
        
        const renderInfoTambahanTab = () => {
            const container = document.getElementById('display-infoTambahan');
            const uniquePeriods = ['Semua Periode', ...new Set(allInfoTambahan.map(i => i.reportingPeriod))].sort();
            const filteredData = infoTambahanPeriodFilter === 'Semua Periode' ? allInfoTambahan : allInfoTambahan.filter(i => i.reportingPeriod === infoTambahanPeriodFilter);

            container.innerHTML = `
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Daftar Info Tambahan</h2>
                <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
                    <div class="flex items-center">
                        <label for="infoTambahanPeriodFilter" class="block text-sm font-medium text-gray-700">Filter Periode</label>
                        <select id="infoTambahanPeriodFilter" class="ml-3 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                             ${uniquePeriods.map(p => `<option value="${p}" ${p === infoTambahanPeriodFilter ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md border">
                    ${filteredData.length === 0 ? '<p class="text-gray-500 p-4">Belum ada data.</p>' : `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cabang</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                        </tr></thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${filteredData.map(info => `
                            <tr data-id="${info.id}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${info.branch}</td>
                                <td class="px-6 py-4 text-sm"><div class="whitespace-pre-wrap">${info.info}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="delete-btn text-red-600 hover:text-red-900" data-type="infoTambahan">Hapus</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`}
                </div>
            `;
        };

        // --- CHART RENDERING FUNCTIONS ---
        const destroyChart = (chartInstance) => {
            if (chartInstance) {
                chartInstance.destroy();
            }
        };

        const renderComplaintsCharts = (data) => {
            destroyChart(complaintsStatusChart);
            destroyChart(complaintsBranchChart);

            if (data.length === 0) return;

            const statusCtx = document.getElementById('complaints-status-chart').getContext('2d');
            const branchCtx = document.getElementById('complaints-branch-chart').getContext('2d');

            const statusCounts = data.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});
            
            const branchCounts = data.reduce((acc, curr) => {
                acc[curr.branch] = (acc[curr.branch] || 0) + 1;
                return acc;
            }, {});

            complaintsStatusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: chartColors,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            complaintsBranchChart = new Chart(branchCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(branchCounts),
                    datasets: [{
                        label: 'Jumlah Komplain',
                        data: Object.values(branchCounts),
                        backgroundColor: '#82ca9d',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        };
        
        const renderSlaCharts = (data) => {
            destroyChart(slaComplianceChart);
            destroyChart(slaStatusChart);
            destroyChart(slaBranchChart);

            const vizContainer = document.getElementById('sla-viz-container');
            if (data.length === 0) {
                vizContainer.innerHTML = '<p class="text-center text-gray-500">Tidak ada data visualisasi untuk ditampilkan.</p>';
                return;
            }

            // Calculate summary
            let totalCompliant = 0, totalNonCompliant = 0;
            const statusCounts = { 'Dalam Proses': 0, 'Selesai': 0 };
            const branchData = branches.map(b => ({ branch: b, compliant: 0, nonCompliant: 0 }));

            data.forEach(rec => {
                totalCompliant += rec.onClinic.jumlahSesuai + rec.onSite.jumlahSesuai;
                totalNonCompliant += rec.onClinic.jumlahTidakSesuai + rec.onSite.jumlahTidakSesuai;
                if(rec.onClinic.jumlahTidakSesuai > 0) statusCounts[rec.onClinic.status]++;
                if(rec.onSite.jumlahTidakSesuai > 0) statusCounts[rec.onSite.status]++;
                
                const branch = branchData.find(b => b.branch === rec.branch);
                if (branch) {
                    branch.compliant += rec.onClinic.jumlahSesuai + rec.onSite.jumlahSesuai;
                    branch.nonCompliant += rec.onClinic.jumlahTidakSesuai + rec.onSite.jumlahTidakSesuai;
                }
            });
            const totalServices = totalCompliant + totalNonCompliant;
            const complianceRatio = totalServices > 0 ? ((totalCompliant / totalServices) * 100).toFixed(2) : 0;

            vizContainer.innerHTML = `
                <h3 class="text-xl font-semibold text-indigo-700 mb-3">Ringkasan SLA</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                    <div><p class="font-medium text-gray-700">Total Layanan</p><p class="text-2xl font-bold">${totalServices}</p></div>
                    <div><p class="font-medium text-green-600">Sesuai SLA</p><p class="text-2xl font-bold">${totalCompliant}</p></div>
                    <div><p class="font-medium text-red-600">Tidak Sesuai</p><p class="text-2xl font-bold">${totalNonCompliant}</p></div>
                    <div><p class="font-medium text-indigo-800">Kepatuhan</p><p class="text-2xl font-bold">${complianceRatio}%</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-md border"><h4 class="text-lg font-semibold text-center mb-3">Rasio Kepatuhan</h4><div class="chart-container"><canvas id="sla-compliance-chart"></canvas></div></div>
                    <div class="bg-white p-4 rounded-lg shadow-md border"><h4 class="text-lg font-semibold text-center mb-3">Status Penanganan</h4><div class="chart-container"><canvas id="sla-status-chart"></canvas></div></div>
                    <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-md border"><h4 class="text-lg font-semibold text-center mb-3">Kinerja per Cabang</h4><div class="chart-container" style="min-height: 300px;"><canvas id="sla-branch-chart"></canvas></div></div>
                </div>
            `;
            
            // Render charts
            slaComplianceChart = new Chart(document.getElementById('sla-compliance-chart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Sesuai SLA', 'Tidak Sesuai SLA'], datasets: [{ data: [totalCompliant, totalNonCompliant], backgroundColor: ['#82ca9d', '#FF8042'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            slaStatusChart = new Chart(document.getElementById('sla-status-chart').getContext('2d'), {
                type: 'pie',
                data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: chartColors }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            slaBranchChart = new Chart(document.getElementById('sla-branch-chart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: branchData.map(b => b.branch),
                    datasets: [
                        { label: 'Sesuai SLA', data: branchData.map(b => b.compliant), backgroundColor: '#82ca9d' },
                        { label: 'Tidak Sesuai SLA', data: branchData.map(b => b.nonCompliant), backgroundColor: '#FF8042' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        };
        
        const renderIssuesCharts = (data) => {
            destroyChart(issuesStatusChart);
            destroyChart(issuesBranchChart);

            if (data.length === 0) return;

            const statusCtx = document.getElementById('issues-status-chart').getContext('2d');
            const branchCtx = document.getElementById('issues-branch-chart').getContext('2d');

            const statusCounts = data.reduce((acc, curr) => {
                acc[curr.status] = (acc[curr.status] || 0) + 1;
                return acc;
            }, {});
            
            const branchCounts = data.reduce((acc, curr) => {
                acc[curr.branch] = (acc[curr.branch] || 0) + 1;
                return acc;
            }, {});

            issuesStatusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: chartColors,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            issuesBranchChart = new Chart(branchCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(branchCounts),
                    datasets: [{
                        label: 'Jumlah Isu',
                        data: Object.values(branchCounts),
                        backgroundColor: '#ffc658',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        };

        // --- EVENT LISTENERS ---
        const addFormEventListeners = () => {
            // Period date change handlers
            const handlePeriodChange = (formId) => {
                const startDateEl = document.getElementById(`${formId}PeriodStartDate`);
                const endDateEl = document.getElementById(`${formId}PeriodEndDate`);
                const displayEl = document.getElementById(`${formId}ReportingPeriodDisplay`);
                
                const updateDisplay = () => {
                    displayEl.value = formatReportingPeriod(startDateEl.value, endDateEl.value);
                };
                
                startDateEl.addEventListener('change', updateDisplay);
                endDateEl.addEventListener('change', updateDisplay);
            };
            handlePeriodChange('comp');
            handlePeriodChange('sla');
            handlePeriodChange('issue');
            handlePeriodChange('info');
            
            // Bullet points for Info Tambahan
            const infoField = document.getElementById('infoField');
            if(infoField) {
                infoField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        e.target.value += '\n• ';
                    }
                });
            }

            // Add button listeners
            document.getElementById('add-complaint-btn').addEventListener('click', addComplaint);
            document.getElementById('add-sla-btn').addEventListener('click', addSlaRecord);
            document.getElementById('add-issue-btn').addEventListener('click', addIssue);
            document.getElementById('add-info-btn').addEventListener('click', addInfoTambahan);
        };
        
        const addDisplayEventListeners = () => {
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'compPeriodFilter') {
                    complaintPeriodFilter = e.target.value;
                    renderComplaintsTab();
                } else if (e.target.id === 'slaPeriodFilter') {
                    slaPeriodFilter = e.target.value;
                    renderSlaTab();
                } else if (e.target.id === 'issuePeriodFilter') {
                    issuePeriodFilter = e.target.value;
                    renderIssuesTab();
                } else if (e.target.id === 'infoTambahanPeriodFilter') {
                    infoTambahanPeriodFilter = e.target.value;
                    renderInfoTambahanTab();
                }
            });

            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                // --- Visualization Toggles ---
                if (button.id === 'toggle-complaints-viz') {
                    showComplaintsViz = !showComplaintsViz;
                    renderComplaintsTab();
                    return; 
                }
                if (button.id === 'toggle-sla-viz') {
                    showSlaViz = !showSlaViz;
                    renderSlaTab();
                    return; 
                }
                if (button.id === 'toggle-issues-viz') {
                    showIssuesViz = !showIssuesViz;
                    renderIssuesTab();
                    return; 
                }
                
                // --- Table Action Buttons ---
                const row = button.closest('tr');
                if (!row) return; 

                const id = row.dataset.id;
                
                if (button.classList.contains('delete-btn')) {
                    const type = button.dataset.type;
                    const message = `Apakah Anda yakin ingin menghapus item ini?`;
                    showConfirmation(message, () => {
                        if (type === 'complaint') deleteItem('complaints', id);
                        else if (type === 'sla') deleteItem('slaRecords', id);
                        else if (type === 'issue') deleteItem('issues', id);
                        else if (type === 'infoTambahan') deleteItem('infoTambahan', id);
                    });
                } else if (button.classList.contains('status-update-btn')) {
                    const type = button.dataset.type;
                    const currentStatus = button.dataset.status;
                    const subService = button.dataset.subservice || null;
                    openStatusUpdateDialog(id, type, currentStatus, subService);
                }
            });
        };

        // --- DATA HANDLING (CRUD) ---
        const addComplaint = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const form = document.getElementById('form-komplain');
            const newComplaint = {
                branch: form.querySelector('[name="branch"]').value,
                title: form.querySelector('[name="title"]').value,
                description: form.querySelector('[name="description"]').value,
                handling: form.querySelector('[name="handling"]').value,
                status: form.querySelector('[name="status"]').value,
                periodStartDate: form.querySelector('[name="periodStartDate"]').value,
                periodEndDate: form.querySelector('[name="periodEndDate"]').value,
            };
            newComplaint.reportingPeriod = formatReportingPeriod(newComplaint.periodStartDate, newComplaint.periodEndDate);
            newComplaint.completionDate = newComplaint.status === 'Selesai' ? formatDate(new Date()) : null;

            if (!newComplaint.branch || !newComplaint.title || !newComplaint.description) {
                return showMessage("Harap lengkapi Cabang, Judul, dan Deskripsi.");
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/complaints`), newComplaint);
                showMessage("Komplain berhasil ditambahkan!");
                renderForms(); // Reset form
            } catch (e) {
                showMessage("Gagal menambahkan komplain.");
                console.error(e);
            }
        };
        
        const addSlaRecord = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const form = document.getElementById('form-sla');
            const newSla = {
                branch: form.querySelector('[name="branch"]').value,
                periodStartDate: form.querySelector('[name="periodStartDate"]').value,
                periodEndDate: form.querySelector('[name="periodEndDate"]').value,
                onClinic: {
                    jumlahSesuai: Number(form.querySelector('[name="onClinic.jumlahSesuai"]').value),
                    jumlahTidakSesuai: Number(form.querySelector('[name="onClinic.jumlahTidakSesuai"]').value),
                    penyebab: form.querySelector('[name="onClinic.penyebab"]').value,
                    penanganan: form.querySelector('[name="onClinic.penanganan"]').value,
                    status: form.querySelector('[name="onClinic.status"]').value,
                },
                onSite: {
                    jumlahSesuai: Number(form.querySelector('[name="onSite.jumlahSesuai"]').value),
                    jumlahTidakSesuai: Number(form.querySelector('[name="onSite.jumlahTidakSesuai"]').value),
                    penyebab: form.querySelector('[name="onSite.penyebab"]').value,
                    penanganan: form.querySelector('[name="onSite.penanganan"]').value,
                    status: form.querySelector('[name="onSite.status"]').value,
                }
            };
            newSla.reportingPeriod = formatReportingPeriod(newSla.periodStartDate, newSla.periodEndDate);
            newSla.onClinic.completionDate = newSla.onClinic.status === 'Selesai' ? formatDate(new Date()) : null;
            newSla.onSite.completionDate = newSla.onSite.status === 'Selesai' ? formatDate(new Date()) : null;

            if (!newSla.branch) return showMessage("Harap pilih Cabang.");
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/slaRecords`), newSla);
                showMessage("Catatan SLA berhasil ditambahkan!");
                renderForms(); // Reset form
            } catch (e) {
                showMessage("Gagal menambahkan catatan SLA.");
                console.error(e);
            }
        };

        const addIssue = async () => {
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const form = document.getElementById('form-isu');
            const newIssue = {
                branch: form.querySelector('[name="branch"]').value,
                issueDescription: form.querySelector('[name="issueDescription"]').value,
                supportRequest: form.querySelector('[name="supportRequest"]').value,
                status: form.querySelector('[name="status"]').value,
                periodStartDate: form.querySelector('[name="periodStartDate"]').value,
                periodEndDate: form.querySelector('[name="periodEndDate"]').value,
            };
            newIssue.reportingPeriod = formatReportingPeriod(newIssue.periodStartDate, newIssue.periodEndDate);
            newIssue.completionDate = newIssue.status === 'Selesai' ? formatDate(new Date()) : null;

            if (!newIssue.branch || !newIssue.issueDescription || !newIssue.supportRequest) {
                return showMessage("Harap lengkapi semua bidang Isu.");
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/issues`), newIssue);
                showMessage("Isu berhasil ditambahkan!");
                renderForms(); // Reset form
            } catch (e) {
                showMessage("Gagal menambahkan isu.");
                console.error(e);
            }
        };

        const addInfoTambahan = async () => {
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const form = document.getElementById('form-infoTambahan');
            const newInfo = {
                branch: form.querySelector('[name="branch"]').value,
                info: form.querySelector('[name="info"]').value,
                periodStartDate: form.querySelector('[name="periodStartDate"]').value,
                periodEndDate: form.querySelector('[name="periodEndDate"]').value,
            };
            newInfo.reportingPeriod = formatReportingPeriod(newInfo.periodStartDate, newInfo.periodEndDate);

            if (!newInfo.branch || !newInfo.info) {
                return showMessage("Harap lengkapi Cabang dan Info.");
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/infoTambahan`), newInfo);
                showMessage("Info berhasil ditambahkan!");
                renderForms(); // Reset form
            } catch (e) {
                showMessage("Gagal menambahkan info.");
                console.error(e);
            }
        };
        
        const deleteItem = async (collectionName, id) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id));
                showMessage("Item berhasil dihapus.");
            } catch (e) {
                showMessage("Gagal menghapus item.");
                console.error(e);
            }
        };

        const openStatusUpdateDialog = (id, type, currentStatus, subService) => {
            statusUpdateSelect.innerHTML = statusOptions.map(opt => `<option value="${opt}" ${opt === currentStatus ? 'selected' : ''}>${opt}</option>`).join('');
            statusUpdateCompletionDate.value = formatDate(new Date());
            statusUpdateCompletionDateContainer.classList.toggle('hidden-dialog', currentStatus !== 'Selesai');
            
            statusUpdateSelect.onchange = () => {
                statusUpdateCompletionDateContainer.classList.toggle('hidden-dialog', statusUpdateSelect.value !== 'Selesai');
            };

            statusUpdateDialog.classList.remove('hidden-dialog');
            statusUpdateDialog.classList.add('flex');
            
            // Handle confirmation
            const newConfirmBtn = statusUpdateConfirmBtn.cloneNode(true);
            statusUpdateConfirmBtn.parentNode.replaceChild(newConfirmBtn, statusUpdateConfirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                handleStatusUpdate(id, type, subService);
            });
        };

        const handleStatusUpdate = async (id, type, subService) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const newStatus = statusUpdateSelect.value;
            const completionDate = newStatus === 'Selesai' ? statusUpdateCompletionDate.value : null;
            let fieldsToUpdate = { status: newStatus, completionDate };
            let collectionName = '';
            
            try {
                if (type === 'complaint') {
                    collectionName = 'complaints';
                } else if (type === 'issue') {
                    collectionName = 'issues';
                } else if (type === 'sla' && subService) {
                    collectionName = 'slaRecords';
                    const record = allSlaRecords.find(r => r.id === id);
                    const updatedSubService = { ...record[subService], status: newStatus, completionDate };
                    fieldsToUpdate = { [subService]: updatedSubService };
                }
                
                const itemRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id);
                await updateDoc(itemRef, fieldsToUpdate);
                showMessage("Status berhasil diperbarui.");
            } catch (e) {
                showMessage("Gagal memperbarui status.");
                console.error(e);
            } finally {
                statusUpdateDialog.classList.add('hidden-dialog');
                statusUpdateDialog.classList.remove('flex');
            }
        };

        // --- EXPORT FUNCTION ---
        const handleExportAllToExcel = () => {
            const filteredComplaints = complaintPeriodFilter === 'Semua Periode' ? allComplaints : allComplaints.filter(c => c.reportingPeriod === complaintPeriodFilter);
            const filteredSla = slaPeriodFilter === 'Semua Periode' ? allSlaRecords : allSlaRecords.filter(s => s.reportingPeriod === slaPeriodFilter);
            const filteredIssues = issuePeriodFilter === 'Semua Periode' ? allIssues : allIssues.filter(i => i.reportingPeriod === issuePeriodFilter);
            const filteredInfo = infoTambahanPeriodFilter === 'Semua Periode' ? allInfoTambahan : allInfoTambahan.filter(i => i.reportingPeriod === infoTambahanPeriodFilter);

            let tableHtml = `<html><head><meta charset="utf-8"/><style>table,th,td{border:1px solid black;border-collapse:collapse;}th,td{padding:5px;}h2{font-weight:bold;}</style></head><body>`;
            
            // Complaints
            if (filteredComplaints.length > 0) {
                tableHtml += `<h2>Laporan Komplain - Periode: ${complaintPeriodFilter}</h2><table><thead><tr><th>Cabang</th><th>Judul</th><th>Deskripsi</th><th>Penanganan</th><th>Status</th><th>Tgl Selesai</th><th>Periode</th></tr></thead><tbody>`;
                filteredComplaints.forEach(c => {
                    tableHtml += `<tr><td>${c.branch}</td><td>${c.title}</td><td>${c.description}</td><td>${c.handling}</td><td>${c.status}</td><td>${c.completionDate || ''}</td><td>${c.reportingPeriod}</td></tr>`;
                });
                tableHtml += '</tbody></table><br/>';
            }
            
            // SLA
            if (filteredSla.length > 0) {
                tableHtml += `<h2>Laporan SLA - Periode: ${slaPeriodFilter}</h2><table><thead><tr><th>Cabang</th><th>Periode</th><th>On Clinic Sesuai</th><th>On Clinic Tdk Sesuai</th><th>On Clinic Penyebab</th><th>On Clinic Penanganan</th><th>On Clinic Status</th><th>On Site Sesuai</th><th>On Site Tdk Sesuai</th><th>On Site Penyebab</th><th>On Site Penanganan</th><th>On Site Status</th></tr></thead><tbody>`;
                filteredSla.forEach(s => {
                    tableHtml += `<tr><td>${s.branch}</td><td>${s.reportingPeriod}</td><td>${s.onClinic.jumlahSesuai}</td><td>${s.onClinic.jumlahTidakSesuai}</td><td>${s.onClinic.penyebab}</td><td>${s.onClinic.penanganan}</td><td>${s.onClinic.status}</td><td>${s.onSite.jumlahSesuai}</td><td>${s.onSite.jumlahTidakSesuai}</td><td>${s.onSite.penyebab}</td><td>${s.onSite.penanganan}</td><td>${s.onSite.status}</td></tr>`;
                });
                tableHtml += '</tbody></table><br/>';
            }
            
            // Issues
            if (filteredIssues.length > 0) {
                tableHtml += `<h2>Laporan Isu - Periode: ${issuePeriodFilter}</h2><table><thead><tr><th>Cabang</th><th>Deskripsi</th><th>Dukungan</th><th>Status</th><th>Tgl Selesai</th><th>Periode</th></tr></thead><tbody>`;
                filteredIssues.forEach(i => {
                    tableHtml += `<tr><td>${i.branch}</td><td>${i.issueDescription}</td><td>${i.supportRequest}</td><td>${i.status}</td><td>${i.completionDate || ''}</td><td>${i.reportingPeriod}</td></tr>`;
                });
                tableHtml += '</tbody></table><br/>';
            }

            // Info
            if (filteredInfo.length > 0) {
                tableHtml += `<h2>Laporan Info Tambahan - Periode: ${infoTambahanPeriodFilter}</h2><table><thead><tr><th>Cabang</th><th>Info</th><th>Periode</th></tr></thead><tbody>`;
                filteredInfo.forEach(info => {
                    tableHtml += `<tr><td>${info.branch}</td><td>${info.info.replace(/\n/g, '<br/>')}</td><td>${info.reportingPeriod}</td></tr>`;
                });
                tableHtml += '</tbody></table>';
            }

            tableHtml += '</body></html>';
            
            if (tableHtml.length < 200) {
                return showMessage("Tidak ada data untuk diekspor.");
            }

            const blob = new Blob([tableHtml], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Laporan_RegII_${formatDate(new Date()).replace(/-/g, '')}.xls`;
            link.click();
        };

        // --- AUTHENTICATION FUNCTIONS ---
        const handleGoogleSignIn = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    errorMessage.textContent = `Gagal login dengan Google: ${error.message}`;
                    errorDisplay.classList.remove('hidden-dialog');
                    errorDisplay.classList.add('flex');
                });
        };

        const handleSignOut = () => {
            signOut(auth).catch((error) => {
                console.error("Sign-Out Error:", error);
                showMessage("Gagal melakukan sign out.");
            });
        };

        // --- INITIALIZATION ---
        const init = () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // ▼▼▼ DAFTAR EMAIL YANG DIIZINKAN (GANTI DENGAN EMAIL ANDA) ▼▼▼
                // Hapus email placeholder di bawah dan ganti dengan alamat email Google
                // yang Anda izinkan untuk mengakses aplikasi ini.
                const authorizedEmails = [
                    "muhherman226@gmail.com",
                    "afm.firmansyahagung@gmail.com",
                    "ekonovidianto7@gmail.com",
                    "fati.imahss@gmail.com",
                    "kadeklestary@gmail.com",
                    "pekaktemplar@gmail.com"
                ];
                // ▲▲▲ AKHIR DARI DAFTAR EMAIL ▲▲▲

                // =======================================================================
                // ▼▼▼ KONFIGURASI FIREBASE ▼▼▼
                // =======================================================================
                const firebaseConfigPlaceholder = {
                    apiKey: "AIzaSyCRNTafMklQKHd4M25nAcs-ZLTK0UxvuGE",
                    authDomain: "myreport-9e7e6.firebaseapp.com",
                    projectId: "myreport-9e7e6",
                    storageBucket: "myreport-9e7e6.firebasestorage.app",
                    messagingSenderId: "1006939537070",
                    appId: "1:1006939537070:web:d1863128a9507491b0b73f"
                };
                
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config) 
                    : firebaseConfigPlaceholder;

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) {
                    throw new Error("Konfigurasi Firebase tidak valid. Ganti nilai placeholder di dalam kode dengan kredensial proyek Firebase Anda.");
                }
                // =======================================================================
                // ▲▲▲ AKHIR DARI BAGIAN KONFIGURASI FIREBASE ▲▲▲
                // =======================================================================

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.style.display = 'none';
                    if (user) {
                        // User is signed in, check if they are authorized
                        if (authorizedEmails.includes(user.email)) {
                            // USER IS AUTHORIZED
                            userId = user.uid;
                            userName.textContent = user.displayName;
                            userEmail.textContent = user.email;
                            userPhoto.src = user.photoURL;

                            loginScreen.classList.add('hidden-dialog');
                            loginScreen.classList.remove('flex');
                            mainContent.classList.remove('hidden');
                            userInfo.classList.remove('hidden-dialog');
                            userInfo.classList.add('flex');
                            
                            setupFirestoreListeners(appId);
                            renderForms();
                            addDisplayEventListeners();
                        } else {
                            // USER IS NOT AUTHORIZED
                            errorMessage.textContent = `Akses Ditolak. Akun Anda (${user.email}) tidak memiliki izin untuk mengakses aplikasi ini.`;
                            errorDisplay.classList.remove('hidden-dialog');
                            errorDisplay.classList.add('flex');
                            mainContent.classList.add('hidden');
                            loginScreen.classList.add('hidden-dialog');
                            loginScreen.classList.remove('flex');
                            // Automatically sign them out
                            handleSignOut();
                        }
                    } else {
                        // User is signed out
                        userId = null;
                        mainContent.classList.add('hidden');
                        userInfo.classList.add('hidden-dialog');
                        userInfo.classList.remove('flex');
                        loginScreen.classList.remove('hidden-dialog');
                        loginScreen.classList.add('flex');
                        errorDisplay.classList.add('hidden-dialog'); // Hide error on sign out
                        errorDisplay.classList.remove('flex');

                        // Clean up old data and listeners
                        firestoreUnsubscribes.forEach(unsub => unsub());
                        firestoreUnsubscribes = [];
                        allComplaints = [];
                        allSlaRecords = [];
                        allIssues = [];
                        allInfoTambahan = [];
                        renderAllTabs(); // Re-render tabs to show they are empty
                    }
                });

            } catch (e) {
                loadingIndicator.style.display = 'none';
                errorMessage.textContent = `Gagal inisialisasi: ${e.message}`;
                errorDisplay.classList.remove('hidden-dialog');
                errorDisplay.classList.add('flex');
                console.error(e);
            }
            
            // Tab switching logic
            document.getElementById('tabs-container').addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    activeTab = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                        btn.classList.add('text-indigo-700', 'hover:bg-indigo-100');
                    });
                    e.target.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                    e.target.classList.remove('text-indigo-700', 'hover:bg-indigo-100');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden-dialog');
                    });
                    document.getElementById(`form-${activeTab}`).classList.remove('hidden-dialog');
                    document.getElementById(`display-${activeTab}`).classList.remove('hidden-dialog');
                }
            });

            // Dialog and Auth button listeners
            messageDialogOkBtn.addEventListener('click', hideMessage);
            confirmationDialogCancelBtn.addEventListener('click', hideConfirmation);
            statusUpdateCancelBtn.addEventListener('click', () => {
                statusUpdateDialog.classList.add('hidden-dialog');
                statusUpdateDialog.classList.remove('flex');
            });
            document.getElementById('export-excel-btn').addEventListener('click', handleExportAllToExcel);
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            signOutBtn.addEventListener('click', handleSignOut);

            // Explicitly hide all dialogs on startup
            messageDialog.classList.add('hidden-dialog');
            messageDialog.classList.remove('flex');
            confirmationDialog.classList.add('hidden-dialog');
            confirmationDialog.classList.remove('flex');
            statusUpdateDialog.classList.add('hidden-dialog');
            statusUpdateDialog.classList.remove('flex');
        };
        
        const setupFirestoreListeners = (appId) => {
            // Clean up previous listeners before attaching new ones
            firestoreUnsubscribes.forEach(unsub => unsub());
            firestoreUnsubscribes = [];

            const collections = ['complaints', 'slaRecords', 'issues', 'infoTambahan'];
            const stateUpdaters = {
                complaints: (data) => { allComplaints = data; renderComplaintsTab(); },
                slaRecords: (data) => { allSlaRecords = data; renderSlaTab(); },
                issues: (data) => { allIssues = data; renderIssuesTab(); },
                infoTambahan: (data) => { allInfoTambahan = data; renderInfoTambahanTab(); }
            };
            
            collections.forEach(name => {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/${name}`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    stateUpdaters[name](data);
                }, (error) => {
                    console.error(`Error fetching ${name}:`, error);
                    showMessage(`Gagal memuat data ${name}.`);
                });
                firestoreUnsubscribes.push(unsubscribe); // Store the cleanup function
            });
        };

        // Start the application
        init();

    </script>
</body>
</html>


