<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyReport</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply the Inter font to the whole application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eaf1ed; /* Main background color */
        }
        /* Custom styles for better visual appeal and to hide elements */
        .hidden-dialog {
            display: none;
        }
        /* Ensure charts don't shrink uncontrollably in a flex/grid container */
        .chart-container {
            position: relative;
            min-height: 250px;
            width: 100%;
        }
        
        /* Animation Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleUp {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .dialog-content {
            animation: scaleUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }

        .dialog-backdrop {
            animation: fadeIn 0.2s ease-out forwards;
        }

        /* Custom button styles */
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #154887;
            color: #fefdfc;
        }
        .btn-primary:hover {
            background-color: #194e91;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: #b68103;
            color: #fefdfc;
        }
        .btn-secondary:hover {
            background-color: #d0ad5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #ee2228;
            color: #fefdfc;
        }
        .btn-danger:hover {
            background-color: #c0171d;
            transform: translateY(-2px);
        }
        .btn-neutral {
            background-color: #e9d9b0;
            color: #154887;
        }
        .btn-neutral:hover {
            background-color: #d0ad5f;
        }
        .data-label {
            font-weight: 600;
            color: #154887;
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 md:p-8">

    <!-- Main Application Container -->
    <div id="app-container">
        <!-- Loading State -->
        <div id="loading-indicator" class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold text-[#154887]">Mengautentikasi & Memuat Data...</div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden-dialog fixed inset-0">
             <div class="dialog-backdrop absolute inset-0 bg-gray-900 bg-opacity-50"></div>
            <div class="dialog-content relative bg-[#fefdfc] p-8 rounded-xl shadow-2xl text-center max-w-sm w-full mx-4">
                <h1 class="text-3xl font-bold text-[#154887] mb-2">MyReport</h1>
                <p class="text-gray-600 mb-6">Autentikasi diperlukan untuk melanjutkan.</p>
                <button id="google-signin-btn" class="w-full bg-[#32629d] text-white py-3 px-4 rounded-lg hover:bg-[#194e91] focus:outline-none focus:ring-2 focus:ring-[#d0ad5f] focus:ring-offset-2 transition-all duration-300 flex items-center justify-center gap-3 btn">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.19 4.223-4.243 5.571l6.252 5.218C41.91 35.778 44 30.551 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-display" class="hidden-dialog items-center justify-center min-h-screen bg-red-100 text-red-700 p-4 rounded-md">
            <p id="error-message" class="text-xl font-semibold text-center"></p>
        </div>

        <!-- Main Application Content (hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Header -->
            <header class="bg-[#fefdfc] shadow-lg rounded-xl p-4 mb-8 flex flex-col sm:flex-row items-center justify-between">
                <h1 class="text-3xl font-bold text-[#154887] mb-2 sm:mb-0">MyReport</h1>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div id="user-info" class="hidden-dialog items-center gap-3">
                        <img id="user-photo" class="w-10 h-10 rounded-full" src="https://placehold.co/40x40/EBF4FF/7F9CF5?text=U" alt="User Photo">
                        <div class="text-sm text-center sm:text-left">
                            <span id="user-name" class="font-semibold text-[#154887]"></span>
                            <span id="user-email" class="text-gray-500 block"></span>
                        </div>
                        <button id="signout-btn" class="ml-4 py-2 px-3 rounded-lg text-sm btn btn-danger">Sign Out</button>
                    </div>
                    <button id="export-excel-btn" class="mt-4 sm:mt-0 py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Export Semua Data
                    </button>
                 </div>
            </header>

            <!-- Navigation Tabs -->
            <nav id="tabs-container" class="mb-8 bg-[#fefdfc] shadow-md rounded-xl p-2 flex flex-wrap justify-center gap-2 sm:gap-4">
                <button data-tab="komplain" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-300 bg-[#154887] text-[#fefdfc] shadow-md">Komplain</button>
                <button data-tab="sla" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-300 text-[#154887] hover:bg-[#e9d9b0]">SLA & Kinerja</button>
                <button data-tab="isu" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-300 text-[#154887] hover:bg-[#e9d9b0]">Isu & Dukungan</button>
                <button data-tab="infoTambahan" class="tab-btn px-4 py-2 rounded-lg font-medium transition-all duration-300 text-[#154887] hover:bg-[#e9d9b0]">Info Tambahan</button>
            </nav>

            <!-- View Switcher -->
            <div class="mb-6 flex justify-center items-center bg-[#fefdfc] shadow-md rounded-xl p-2 gap-2 max-w-xs mx-auto">
                <button id="view-input-btn" class="w-1/2 px-4 py-2 rounded-lg font-medium transition-all duration-300 bg-[#154887] text-[#fefdfc]">Input Data</button>
                <button id="view-dashboard-btn" class="w-1/2 px-4 py-2 rounded-lg font-medium transition-all duration-300 text-[#154887] hover:bg-[#e9d9b0]">Dashboard</button>
            </div>

            <!-- Main Content Area -->
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Input Forms Column -->
                <div id="input-column" class="lg:col-span-1 bg-[#fefdfc] p-6 rounded-xl shadow-lg border border-[#e9d9b0] transition-all duration-300">
                    <div id="form-komplain" class="tab-content"></div>
                    <div id="form-sla" class="tab-content hidden-dialog"></div>
                    <div id="form-isu" class="tab-content hidden-dialog"></div>
                    <div id="form-infoTambahan" class="tab-content hidden-dialog"></div>
                </div>

                <!-- Display List Column -->
                <div id="display-column" class="lg:col-span-2 transition-all duration-300">
                    <div id="display-komplain" class="tab-content bg-[#fefdfc] p-6 rounded-xl shadow-lg border border-[#e9d9b0]"></div>
                    <div id="display-sla" class="tab-content hidden-dialog bg-[#fefdfc] p-6 rounded-xl shadow-lg border border-[#e9d9b0]"></div>
                    <div id="display-isu" class="tab-content hidden-dialog bg-[#fefdfc] p-6 rounded-xl shadow-lg border border-[#e9d9b0]"></div>
                    <div id="display-infoTambahan" class="tab-content hidden-dialog bg-[#fefdfc] p-6 rounded-xl shadow-lg border border-[#e9d9b0]"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Dialogs -->
    <div id="message-dialog" class="hidden-dialog fixed inset-0 z-50">
        <div class="dialog-backdrop absolute inset-0 bg-gray-900 bg-opacity-60"></div>
        <div class="dialog-content relative bg-[#fefdfc] rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <p id="message-dialog-content" class="text-lg font-medium text-gray-800 mb-4"></p>
            <button id="message-dialog-ok-btn" class="w-full py-2 px-4 rounded-lg btn btn-primary">OK</button>
        </div>
    </div>
    <div id="confirmation-dialog" class="hidden-dialog fixed inset-0 z-50">
        <div class="dialog-backdrop absolute inset-0 bg-gray-900 bg-opacity-60"></div>
        <div class="dialog-content relative bg-[#fefdfc] rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <p id="confirmation-dialog-content" class="text-lg font-medium text-gray-800 mb-4"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmation-dialog-cancel-btn" class="px-4 py-2 rounded-lg btn btn-neutral">Batal</button>
                <button id="confirmation-dialog-confirm-btn" class="px-4 py-2 rounded-lg btn btn-danger">Konfirmasi</button>
            </div>
        </div>
    </div>
    <div id="status-update-dialog" class="hidden-dialog fixed inset-0 z-50">
        <div class="dialog-backdrop absolute inset-0 bg-gray-900 bg-opacity-60"></div>
        <div class="dialog-content relative bg-[#fefdfc] rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <h3 class="text-xl font-semibold text-[#154887] mb-4">Ubah Status</h3>
            <div class="mb-4">
                <label for="status-update-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Status Baru</label>
                <select id="status-update-select" class="w-full p-2 border border-[#d0ad5f] rounded-md focus:ring-2 focus:ring-[#b68103] focus:border-[#b68103]"></select>
            </div>
            <div id="status-update-completion-date-container" class="mb-4 hidden-dialog">
                <label for="status-update-completion-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label>
                <input type="date" id="status-update-completion-date" class="w-full p-2 border border-[#d0ad5f] rounded-md focus:ring-2 focus:ring-[#b68103] focus:border-[#b68103]">
            </div>
            <div class="flex justify-end gap-3">
                <button id="status-update-cancel-btn" class="px-4 py-2 rounded-lg btn btn-neutral">Batal</button>
                <button id="status-update-confirm-btn" class="px-4 py-2 rounded-lg btn btn-primary">Simpan</button>
            </div>
        </div>
    </div>
    <!-- Info Edit Dialog -->
    <div id="info-edit-dialog" class="hidden-dialog fixed inset-0 z-50">
        <div class="dialog-backdrop absolute inset-0 bg-gray-900 bg-opacity-60"></div>
        <div class="dialog-content relative bg-[#fefdfc] rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-[#154887] mb-4">Edit Info Tambahan</h3>
            <div class="mb-4">
                <label for="info-edit-field" class="block text-sm font-medium text-gray-700 mb-1">Info</label>
                <textarea id="info-edit-field" rows="8" class="w-full p-2 border border-[#d0ad5f] rounded-md focus:ring-2 focus:ring-[#b68103] focus:border-[#b68103]"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button id="info-edit-cancel-btn" class="px-4 py-2 rounded-lg btn btn-neutral">Batal</button>
                <button id="info-edit-confirm-btn" class="px-4 py-2 rounded-lg btn btn-primary">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-report-app-default';
        let db, auth;
        let userId = null;
        let activeTab = 'komplain';
        let currentView = 'input';
        let firestoreUnsubscribes = [];
        let allComplaints = [], allSlaRecords = [], allIssues = [], allInfoTambahan = [];
        let complaintPeriodFilter = 'Semua Periode', slaPeriodFilter = 'Semua Periode', issuePeriodFilter = 'Semua Periode', infoTambahanPeriodFilter = 'Semua Periode';
        let complaintBranchFilter = 'Semua Cabang', slaBranchFilter = 'Semua Cabang', issueBranchFilter = 'Semua Cabang', infoTambahanBranchFilter = 'Semua Cabang';
        let showComplaintsViz = false, showSlaViz = false, showIssuesViz = false;
        let complaintsStatusChart, complaintsBranchChart, slaComplianceChart, slaStatusChart, slaBranchChart, issuesStatusChart, issuesBranchChart;
        const branches = ['Mataram', 'Maluk', 'Bali', 'Surabaya', 'Yogyakarta', 'Semarang'];
        const statusOptions = ['Dalam Proses', 'Selesai'];
        const chartColors = ['#32629d', '#82ca9d', '#e9d9b0', '#d0ad5f', '#194e91', '#b39058'];

        const loadingIndicator = document.getElementById('loading-indicator');
        const loginScreen = document.getElementById('login-screen');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const userPhoto = document.getElementById('user-photo');
        const signOutBtn = document.getElementById('signout-btn');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const messageDialog = document.getElementById('message-dialog');
        const messageDialogContent = document.getElementById('message-dialog-content');
        const messageDialogOkBtn = document.getElementById('message-dialog-ok-btn');
        const confirmationDialog = document.getElementById('confirmation-dialog');
        const confirmationDialogContent = document.getElementById('confirmation-dialog-content');
        const confirmationDialogCancelBtn = document.getElementById('confirmation-dialog-cancel-btn');
        let confirmationDialogConfirmBtn = document.getElementById('confirmation-dialog-confirm-btn');
        const statusUpdateDialog = document.getElementById('status-update-dialog');
        const statusUpdateSelect = document.getElementById('status-update-select');
        const statusUpdateCompletionDateContainer = document.getElementById('status-update-completion-date-container');
        const statusUpdateCompletionDate = document.getElementById('status-update-completion-date');
        const statusUpdateCancelBtn = document.getElementById('status-update-cancel-btn');
        let statusUpdateConfirmBtn = document.getElementById('status-update-confirm-btn');
        const infoEditDialog = document.getElementById('info-edit-dialog');
        const infoEditField = document.getElementById('info-edit-field');
        const infoEditCancelBtn = document.getElementById('info-edit-cancel-btn');
        let infoEditConfirmBtn = document.getElementById('info-edit-confirm-btn');

        const formatDate = (date) => new Date(date).toISOString().split('T')[0];
        const getReportingPeriodDetails = (date = new Date()) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return {
                startDate: formatDate(monday),
                endDate: formatDate(sunday),
                formattedPeriod: `${formatDate(monday)} s/d ${formatDate(sunday)}`
            };
        };
        const formatReportingPeriod = (startDateStr, endDateStr) => startDateStr && endDateStr ? `${startDateStr} s/d ${endDateStr}` : '';
        const showDialog = (el) => { el.classList.remove('hidden-dialog'); el.classList.add('flex', 'items-center', 'justify-center'); };
        const hideDialog = (el) => { el.classList.add('hidden-dialog'); el.classList.remove('flex', 'items-center', 'justify-center'); };
        const showMessage = (message) => { messageDialogContent.textContent = message; showDialog(messageDialog); };
        const showConfirmation = (message, onConfirm) => {
            confirmationDialogContent.textContent = message;
            const newBtn = confirmationDialogConfirmBtn.cloneNode(true);
            confirmationDialogConfirmBtn.parentNode.replaceChild(newBtn, confirmationDialogConfirmBtn);
            confirmationDialogConfirmBtn = newBtn;
            confirmationDialogConfirmBtn.onclick = () => { onConfirm(); hideDialog(confirmationDialog); };
            showDialog(confirmationDialog);
        };
        const createFormElement = (id, name, label, type = 'text', options = {}) => {
            const { placeholder = '', value = '', rows = 3, required = false, selectOptions = [] } = options;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `<label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>`;
            let inputEl;
            if (type === 'select') {
                inputEl = document.createElement('select');
                inputEl.innerHTML = `<option value="" disabled ${!value ? 'selected' : ''}>Pilih ${label}</option>` +
                                 selectOptions.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('');
            } else if (type === 'textarea') {
                inputEl = document.createElement('textarea');
                inputEl.rows = rows;
                inputEl.placeholder = placeholder;
                inputEl.textContent = value;
            } else {
                inputEl = document.createElement('input');
                inputEl.type = type;
                inputEl.placeholder = placeholder;
                inputEl.value = value;
            }
            inputEl.id = id;
            inputEl.name = name;
            inputEl.className = "w-full p-2 border border-[#d0ad5f] rounded-md focus:ring-2 focus:ring-[#b68103] focus:border-[#b68103] transition-colors duration-200";
            if (options.readOnly) { inputEl.readOnly = true; inputEl.classList.add('bg-gray-100'); }
            if (required) inputEl.required = true;
            wrapper.appendChild(inputEl);
            return wrapper.outerHTML;
        };

        const renderForms = () => {
            const period = getReportingPeriodDetails();
            const commonFields = (prefix) => `
                ${createFormElement(`${prefix}Branch`, 'branch', 'Cabang', 'select', { selectOptions: branches, required: true })}
                ${createFormElement(`${prefix}PeriodStartDate`, 'periodStartDate', 'Mulai Periode', 'date', { value: period.startDate, required: true })}
                ${createFormElement(`${prefix}PeriodEndDate`, 'periodEndDate', 'Akhir Periode', 'date', { value: period.endDate, required: true })}
                ${createFormElement(`${prefix}ReportingPeriodDisplay`, 'reportingPeriodDisplay', 'Periode Pelaporan', 'text', { value: period.formattedPeriod, readOnly: true })}
            `;
            document.getElementById('form-komplain').innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-[#154887]">Tambah Komplain</h2><div class="space-y-4">${commonFields('comp')}${createFormElement('compTitle', 'title', 'Judul', 'text', { required: true })}${createFormElement('compDesc', 'description', 'Deskripsi', 'textarea', { required: true })}${createFormElement('compHandling', 'handling', 'Penanganan', 'textarea')}${createFormElement('compStatus', 'status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' })}<button id="add-complaint-btn" class="w-full py-2 rounded-lg btn btn-primary">Tambah</button></div>`;
            document.getElementById('form-sla').innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-[#154887]">Tambah Catatan SLA</h2><div class="space-y-4">${commonFields('sla')}
                <div class="bg-[#eaf1ed] p-4 rounded-lg space-y-2"><h3 class="text-lg font-semibold text-[#154887]">On Clinic</h3>${createFormElement('onClinicTotalLayanan', 'onClinic.totalLayanan', 'Total Layanan', 'number', { value: 0 })}${createFormElement('onClinicJumlahSesuai', 'onClinic.jumlahSesuai', 'Jml Sesuai', 'number', { value: 0 })}${createFormElement('onClinicJumlahTidakSesuai', 'onClinic.jumlahTidakSesuai', 'Jml Tdk Sesuai', 'number', { value: 0 })}<div id="onClinic-conditional-fields" class="hidden-dialog space-y-2 mt-2">${createFormElement('onClinicPenyebab', 'onClinic.penyebab', 'Penyebab', 'textarea')}${createFormElement('onClinicPenanganan', 'onClinic.penanganan', 'Penanganan', 'textarea')}${createFormElement('onClinicStatus', 'onClinic.status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' })}</div></div>
                <div class="bg-[#eaf1ed] p-4 rounded-lg space-y-2"><h3 class="text-lg font-semibold text-[#154887]">On Site</h3>${createFormElement('onSiteTotalLayanan', 'onSite.totalLayanan', 'Total Layanan', 'number', { value: 0 })}${createFormElement('onSiteJumlahSesuai', 'onSite.jumlahSesuai', 'Jml Sesuai', 'number', { value: 0 })}${createFormElement('onSiteJumlahTidakSesuai', 'onSite.jumlahTidakSesuai', 'Jml Tdk Sesuai', 'number', { value: 0 })}<div id="onSite-conditional-fields" class="hidden-dialog space-y-2 mt-2">${createFormElement('onSitePenyebab', 'onSite.penyebab', 'Penyebab', 'textarea')}${createFormElement('onSitePenanganan', 'onSite.penanganan', 'Penanganan', 'textarea')}${createFormElement('onSiteStatus', 'onSite.status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' })}</div></div>
                <button id="add-sla-btn" class="w-full py-2 rounded-lg btn btn-primary">Tambah</button></div>`;
            document.getElementById('form-isu').innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-[#154887]">Tambah Isu</h2><div class="space-y-4">${commonFields('issue')}
                <div class="bg-[#eaf1ed] p-4 rounded-lg space-y-2"><h3 class="text-lg font-semibold text-[#154887]">Detail</h3>${createFormElement('issueDesc', 'issueDescription', 'Deskripsi', 'textarea', { required: true })}${createFormElement('issueSupport', 'supportRequest', 'Dukungan', 'textarea', { required: true })}${createFormElement('issueStatus', 'status', 'Status', 'select', { selectOptions: statusOptions, value: 'Dalam Proses' })}</div>
                <button id="add-issue-btn" class="w-full py-2 rounded-lg btn btn-primary">Tambah</button></div>`;
            document.getElementById('form-infoTambahan').innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-[#154887]">Tambah Info</h2><div class="space-y-4">${commonFields('info')}${createFormElement('infoField', 'info', 'Info', 'textarea', { rows: 5, value: '• ', required: true })}<button id="add-info-btn" class="w-full py-2 rounded-lg btn btn-primary">Tambah</button></div>`;
            addFormEventListeners();
        };
        const renderDisplayTab = (tabId, title, data, periodFilter, branchFilter, headers, rowRenderer, hasViz = false) => {
            const container = document.getElementById(`display-${tabId}`);
            const uniquePeriods = ['Semua Periode', ...new Set(data.map(d => d.reportingPeriod))].filter(Boolean).sort();
            
            let filteredData = data;
            if (periodFilter !== 'Semua Periode') {
                filteredData = filteredData.filter(d => d.reportingPeriod === periodFilter);
            }
            if (branchFilter !== 'Semua Cabang') {
                filteredData = filteredData.filter(d => d.branch === branchFilter);
            }

            const showViz = tabId === 'komplain' ? showComplaintsViz : (tabId === 'sla' ? showSlaViz : showIssuesViz);
            container.innerHTML = `<h2 class="text-2xl font-semibold mb-4 text-[#154887]">${title}</h2>
                <div class="mb-4 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex items-center"><label for="${tabId}PeriodFilter" class="text-sm font-medium mr-2">Periode:</label><select id="${tabId}PeriodFilter" class="p-2 border border-[#d0ad5f] rounded-md focus:ring-[#b68103] focus:border-[#b68103]">${uniquePeriods.map(p => `<option value="${p}" ${p === periodFilter ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                        <div class="flex items-center"><label for="${tabId}BranchFilter" class="text-sm font-medium mr-2">Cabang:</label><select id="${tabId}BranchFilter" class="p-2 border border-[#d0ad5f] rounded-md focus:ring-[#b68103] focus:border-[#b68103]"><option value="Semua Cabang">Semua Cabang</option>${branches.map(b => `<option value="${b}" ${b === branchFilter ? 'selected' : ''}>${b}</option>`).join('')}</select></div>
                    </div>
                    ${hasViz ? `<button id="toggle-${tabId}-viz" class="px-3 py-2 text-sm rounded-lg btn btn-primary">${showViz ? 'Sembunyikan' : 'Tampilkan'} Visualisasi</button>` : ''}
                </div>
                ${hasViz ? `<div id="${tabId}-viz-container" class="${showViz ? '' : 'hidden-dialog'} grid md:grid-cols-2 gap-6 mb-6"></div>` : ''}
                <div class="overflow-x-auto rounded-lg shadow-md border border-[#e9d9b0]">${filteredData.length === 0 ? `<p class="text-gray-500 p-4 text-center">Belum ada data.</p>` : `<table class="min-w-full">
                        <thead class="bg-[#eaf1ed]"><tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-semibold text-[#154887] uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>
                        ${rowRenderer(filteredData)}</table>`}
                </div>`;
            if (showViz) {
                if (tabId === 'komplain') renderComplaintsCharts(filteredData);
                if (tabId === 'sla') renderSlaCharts(filteredData);
                if (tabId === 'isu') renderIssuesCharts(filteredData);
            }
        };

        const renderAllTabs = () => {
            renderDisplayTab('komplain', 'Daftar Komplain', allComplaints, complaintPeriodFilter, complaintBranchFilter, 
                ['Detail Komplain', 'Status', 'Aksi'], 
                (data) => data.map(c => `
                    <tbody class="border-t-4 border-b-4 border-[#b39058]">
                        <tr class="bg-white">
                            <td class="px-6 py-4 align-top">
                                <div class="text-sm"><span class="data-label">Cabang:</span> ${c.branch}</div>
                                <div class="text-sm"><span class="data-label">Periode:</span> ${c.reportingPeriod}</div>
                                <div class="text-sm font-semibold text-black mt-2">${c.title}</div>
                            </td>
                            <td class="px-6 py-4 align-top">
                                <div class="font-semibold ${c.status === 'Selesai' ? 'text-green-600' : 'text-[#32629d]'}">${c.status}</div>
                                ${c.completionDate ? `<div class="text-xs text-gray-500">Selesai: ${c.completionDate}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 align-top">
                                <div class="flex gap-4">
                                    <button class="status-update-btn text-[#154887] hover:text-[#32629d] font-semibold" data-type="complaint" data-id="${c.id}" data-status="${c.status}">Ubah</button>
                                    <button class="delete-btn text-[#ee2228] hover:text-[#c0171d] font-semibold" data-type="complaint" data-id="${c.id}">Hapus</button>
                                </div>
                            </td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4" colspan="3">
                                <div class="text-sm mb-2"><span class="data-label">Deskripsi:</span> <div class="whitespace-pre-wrap pl-2">${c.description}</div></div>
                                <div class="text-sm"><span class="data-label">Penanganan:</span> <div class="whitespace-pre-wrap pl-2">${c.handling || '-'}</div></div>
                            </td>
                        </tr>
                    </tbody>
                `).join(''), true);
            
            const getStatusDisplay = (serviceData) => {
                if (!serviceData || serviceData.jumlahTidakSesuai === null || serviceData.jumlahTidakSesuai === undefined) return '<span class="text-gray-400">-</span>';
                if (Number(serviceData.jumlahTidakSesuai) === 0) return '<span class="text-green-600 font-semibold">Sesuai SLA</span>';
                return `<span class="font-semibold ${serviceData.status === 'Selesai' ? 'text-green-600' : 'text-[#32629d]'}">${serviceData.status || 'Dalam Proses'}</span>`;
            };
            renderDisplayTab('sla', 'Catatan SLA', allSlaRecords, slaPeriodFilter, slaBranchFilter, 
                ['Detail Cabang & Periode', 'Detail Layanan', 'Aksi'],
                (data) => data.map(s => `
                    <tbody data-id="${s.id}" class="border-t-4 border-b-4 border-[#b39058]">
                        <tr class="bg-white">
                           <td class="px-6 py-4 align-top" rowspan="2">
                                <div class="text-sm"><span class="data-label">Cabang:</span> ${s.branch}</div>
                                <div class="text-sm"><span class="data-label">Periode:</span> ${s.reportingPeriod}</div>
                           </td>
                           <td class="px-6 py-4 border-b border-[#e9d9b0]">
                                <div class="data-label mb-1">On Clinic</div>
                                <div class="text-sm">Total: ${s.onClinic.totalLayanan} | Sesuai: ${s.onClinic.jumlahSesuai} | Tdk Sesuai: ${s.onClinic.jumlahTidakSesuai}</div>
                                <div class="text-sm mt-1"><span class="font-semibold">Status:</span> ${getStatusDisplay(s.onClinic)}</div>
                                ${Number(s.onClinic.jumlahTidakSesuai) > 0 ? `
                                <div class="text-xs text-gray-600 mt-2"><span class="font-semibold">Penyebab:</span> ${s.onClinic.penyebab || '-'}</div>
                                <div class="text-xs text-gray-600"><span class="font-semibold">Penanganan:</span> ${s.onClinic.penanganan || '-'}</div>
                                ` : ''}
                           </td>
                           <td class="px-6 py-4 align-middle" rowspan="2">
                                <div class="flex flex-col gap-2">
                                    <button class="status-update-btn text-[#154887] hover:text-[#32629d] text-left font-semibold disabled:text-gray-400 disabled:cursor-not-allowed" data-type="sla" data-id="${s.id}" data-subservice="onClinic" data-status="${s.onClinic.status}" ${s.onClinic.jumlahTidakSesuai === 0 ? 'disabled' : ''}>Ubah On Clinic</button>
                                    <button class="status-update-btn text-[#154887] hover:text-[#32629d] text-left font-semibold disabled:text-gray-400 disabled:cursor-not-allowed" data-type="sla" data-id="${s.id}" data-subservice="onSite" data-status="${s.onSite.status}" ${s.onSite.jumlahTidakSesuai === 0 ? 'disabled' : ''}>Ubah On Site</button>
                                    <button class="delete-btn text-[#ee2228] hover:text-[#c0171d] text-left mt-1 font-semibold" data-type="sla" data-id="${s.id}">Hapus Data</button>
                                </div>
                           </td>
                        </tr>
                        <tr class="bg-white">
                           <td class="px-6 py-4">
                                <div class="data-label mb-1">On Site</div>
                                <div class="text-sm">Total: ${s.onSite.totalLayanan} | Sesuai: ${s.onSite.jumlahSesuai} | Tdk Sesuai: ${s.onSite.jumlahTidakSesuai}</div>
                                <div class="text-sm mt-1"><span class="font-semibold">Status:</span> ${getStatusDisplay(s.onSite)}</div>
                                ${Number(s.onSite.jumlahTidakSesuai) > 0 ? `
                                <div class="text-xs text-gray-600 mt-2"><span class="font-semibold">Penyebab:</span> ${s.onSite.penyebab || '-'}</div>
                                <div class="text-xs text-gray-600"><span class="font-semibold">Penanganan:</span> ${s.onSite.penanganan || '-'}</div>
                                ` : ''}
                           </td>
                        </tr>
                    </tbody>
                `).join(''), true);

            renderDisplayTab('isu', 'Isu & Dukungan', allIssues, issuePeriodFilter, issueBranchFilter, 
                ['Detail Isu', 'Status', 'Aksi'], 
                (data) => data.map(i => `
                    <tbody class="border-t-4 border-b-4 border-[#b39058]">
                        <tr class="bg-white">
                            <td class="px-6 py-4 align-top">
                                <div class="text-sm"><span class="data-label">Cabang:</span> ${i.branch}</div>
                                <div class="text-sm"><span class="data-label">Periode:</span> ${i.reportingPeriod}</div>
                            </td>
                            <td class="px-6 py-4 align-top">
                                <div class="font-semibold ${i.status === 'Selesai' ? 'text-green-600' : 'text-[#32629d]'}">${i.status}</div>
                                ${i.completionDate ? `<div class="text-xs text-gray-500">Selesai: ${i.completionDate}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 align-top">
                                <div class="flex gap-4">
                                    <button class="status-update-btn text-[#154887] hover:text-[#32629d] font-semibold" data-type="issue" data-id="${i.id}" data-status="${i.status}">Ubah</button>
                                    <button class="delete-btn text-[#ee2228] hover:text-[#c0171d] font-semibold" data-type="issue" data-id="${i.id}">Hapus</button>
                                </div>
                            </td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4" colspan="3">
                                <div class="text-sm mb-2"><span class="data-label">Deskripsi Isu:</span> <div class="whitespace-pre-wrap pl-2">${i.issueDescription}</div></div>
                                <div class="text-sm"><span class="data-label">Permintaan Dukungan:</span> <div class="whitespace-pre-wrap pl-2">${i.supportRequest || '-'}</div></div>
                            </td>
                        </tr>
                    </tbody>
                `).join(''), true);
            
            renderDisplayTab('infoTambahan', 'Info Tambahan', allInfoTambahan, infoTambahanPeriodFilter, infoTambahanBranchFilter, 
                ['Cabang', 'Info', 'Aksi'], 
                (data) => data.map(info => `
                    <tbody data-id="${info.id}" class="border-t border-b">
                        <tr class="hover:bg-[#eaf1ed] transition-colors duration-200">
                            <td class="px-6 py-4 w-1/4 align-top">${info.branch}</td>
                            <td class="px-6 py-4 w-2/4 whitespace-pre-wrap">${info.info}</td>
                            <td class="px-6 py-4 w-1/4 align-top">
                                <div class="flex gap-4">
                                    <button class="edit-btn text-[#154887] hover:text-[#32629d] font-semibold" data-type="infoTambahan" data-id="${info.id}">Edit</button>
                                    <button class="delete-btn text-[#ee2228] hover:text-[#c0171d] font-semibold" data-type="infoTambahan" data-id="${info.id}">Hapus</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                `).join(''));
        };

        const destroyChart = (chart) => chart && chart.destroy();
        const renderChart = (ctx, type, data, options = {}) => new Chart(ctx, { type, data, options });
        const renderViz = (containerId, charts) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = charts.map(c => `<div class="bg-[#fefdfc] p-4 rounded-lg border border-[#e9d9b0]"><h3 class="text-xl font-semibold text-center mb-3 text-[#154887]">${c.title}</h3><div class="chart-container"><canvas id="${c.id}"></canvas></div></div>`).join('');
            charts.forEach(c => c.renderer());
        };
        const renderComplaintsCharts = (data) => {
            destroyChart(complaintsStatusChart); destroyChart(complaintsBranchChart); if (!data.length) return;
            const statusCounts = data.reduce((acc, { status }) => (acc[status] = (acc[status] || 0) + 1, acc), {});
            const branchCounts = data.reduce((acc, { branch }) => (acc[branch] = (acc[branch] || 0) + 1, acc), {});
            renderViz('complaints-viz-container', [
                { id: 'complaints-status-chart', title: 'Komplain per Status', renderer: () => complaintsStatusChart = renderChart(document.getElementById('complaints-status-chart').getContext('2d'), 'pie', { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: chartColors }] }, { responsive: true, maintainAspectRatio: false }) },
                { id: 'complaints-branch-chart', title: 'Komplain per Cabang', renderer: () => complaintsBranchChart = renderChart(document.getElementById('complaints-branch-chart').getContext('2d'), 'bar', { labels: Object.keys(branchCounts), datasets: [{ label: 'Jml', data: Object.values(branchCounts), backgroundColor: '#82ca9d' }] }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }) }
            ]);
        };
        const renderSlaCharts = (data) => {
            destroyChart(slaComplianceChart); destroyChart(slaStatusChart); destroyChart(slaBranchChart);
            const vizContainer = document.getElementById('sla-viz-container');
            if (!vizContainer || data.length === 0) { if(vizContainer) vizContainer.innerHTML = '<p class="text-center text-gray-500">Tidak ada data visualisasi.</p>'; return; }
            let totalCompliant = 0, totalNonCompliant = 0;
            const statusCounts = { 'Dalam Proses': 0, 'Selesai': 0 };
            const branchData = branches.reduce((acc, b) => (acc[b] = { compliant: 0, nonCompliant: 0 }, acc), {});
            data.forEach(rec => {
                ['onClinic', 'onSite'].forEach(type => {
                    totalCompliant += rec[type]?.jumlahSesuai || 0;
                    totalNonCompliant += rec[type]?.jumlahTidakSesuai || 0;
                    if (rec[type]?.jumlahTidakSesuai > 0) statusCounts[rec[type].status]++;
                    if (branchData[rec.branch]) {
                        branchData[rec.branch].compliant += rec[type]?.jumlahSesuai || 0;
                        branchData[rec.branch].nonCompliant += rec[type]?.jumlahTidakSesuai || 0;
                    }
                });
            });
            const totalServices = totalCompliant + totalNonCompliant;
            const complianceRatio = totalServices > 0 ? ((totalCompliant / totalServices) * 100).toFixed(2) : 0;
            vizContainer.innerHTML = `<h3 class="text-xl font-semibold mb-3 text-[#154887]">Ringkasan SLA</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"><div><p>Total Layanan</p><p class="text-2xl font-bold">${totalServices}</p></div><div><p class="text-green-600">Sesuai SLA</p><p class="text-2xl font-bold">${totalCompliant}</p></div><div><p class="text-red-600">Tidak Sesuai</p><p class="text-2xl font-bold">${totalNonCompliant}</p></div><div><p class="text-[#154887]">Kepatuhan</p><p class="text-2xl font-bold">${complianceRatio}%</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-4 rounded-lg border border-[#e9d9b0]"><h4 class="text-lg font-semibold text-center mb-3 text-[#154887]">Rasio Kepatuhan</h4><div class="chart-container"><canvas id="sla-compliance-chart"></canvas></div></div><div class="bg-white p-4 rounded-lg border border-[#e9d9b0]"><h4 class="text-lg font-semibold text-center mb-3 text-[#154887]">Status Penanganan</h4><div class="chart-container"><canvas id="sla-status-chart"></canvas></div></div><div class="lg:col-span-2 bg-white p-4 rounded-lg border border-[#e9d9b0]"><h4 class="text-lg font-semibold text-center mb-3 text-[#154887]">Kinerja per Cabang</h4><div class="chart-container" style="min-height: 300px;"><canvas id="sla-branch-chart"></canvas></div></div></div>`;
            slaComplianceChart = renderChart(document.getElementById('sla-compliance-chart').getContext('2d'), 'doughnut', { labels: ['Sesuai', 'Tdk Sesuai'], datasets: [{ data: [totalCompliant, totalNonCompliant], backgroundColor: ['#82ca9d', '#ee2228'] }] }, { responsive: true, maintainAspectRatio: false });
            slaStatusChart = renderChart(document.getElementById('sla-status-chart').getContext('2d'), 'pie', { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: chartColors }] }, { responsive: true, maintainAspectRatio: false });
            slaBranchChart = renderChart(document.getElementById('sla-branch-chart').getContext('2d'), 'bar', { labels: Object.keys(branchData), datasets: [{ label: 'Sesuai', data: Object.values(branchData).map(b => b.compliant), backgroundColor: '#82ca9d' }, { label: 'Tdk Sesuai', data: Object.values(branchData).map(b => b.nonCompliant), backgroundColor: '#ee2228' }] }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } });
        };
        const renderIssuesCharts = (data) => {
            destroyChart(issuesStatusChart); destroyChart(issuesBranchChart); if (!data.length) return;
            const statusCounts = data.reduce((acc, { status }) => (acc[status] = (acc[status] || 0) + 1, acc), {});
            const branchCounts = data.reduce((acc, { branch }) => (acc[branch] = (acc[branch] || 0) + 1, acc), {});
            renderViz('issues-viz-container', [
                { id: 'issues-status-chart', title: 'Isu per Status', renderer: () => issuesStatusChart = renderChart(document.getElementById('issues-status-chart').getContext('2d'), 'pie', { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: chartColors }] }, { responsive: true, maintainAspectRatio: false }) },
                { id: 'issues-branch-chart', title: 'Isu per Cabang', renderer: () => issuesBranchChart = renderChart(document.getElementById('issues-branch-chart').getContext('2d'), 'bar', { labels: Object.keys(branchCounts), datasets: [{ label: 'Jml', data: Object.values(branchCounts), backgroundColor: '#ffc658' }] }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }) }
            ]);
        };
        const addFormEventListeners = () => {
            const handlePeriodChange = (prefix) => {
                const start = document.getElementById(`${prefix}PeriodStartDate`);
                const end = document.getElementById(`${prefix}PeriodEndDate`);
                if (start && end) {
                    const update = () => document.getElementById(`${prefix}ReportingPeriodDisplay`).value = formatReportingPeriod(start.value, end.value);
                    start.onchange = update;
                    end.onchange = update;
                }
            };
            ['comp', 'sla', 'issue', 'info'].forEach(handlePeriodChange);
            const infoField = document.getElementById('infoField');
            if(infoField) infoField.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); e.target.value += '\n• '; } };
            
            const setupSlaConditionalFields = () => {
                const onClinicTdkSesuai = document.getElementById('onClinicJumlahTidakSesuai');
                const onSiteTdkSesuai = document.getElementById('onSiteJumlahTidakSesuai');
                const onClinicFields = document.getElementById('onClinic-conditional-fields');
                const onSiteFields = document.getElementById('onSite-conditional-fields');

                const toggleFields = (input, fieldsContainer) => {
                    if (Number(input.value) > 0) {
                        fieldsContainer.classList.remove('hidden-dialog');
                    } else {
                        fieldsContainer.classList.add('hidden-dialog');
                    }
                };
                if(onClinicTdkSesuai) onClinicTdkSesuai.addEventListener('input', () => toggleFields(onClinicTdkSesuai, onClinicFields));
                if(onSiteTdkSesuai) onSiteTdkSesuai.addEventListener('input', () => toggleFields(onSiteTdkSesuai, onSiteFields));
            };
            setupSlaConditionalFields();

            document.getElementById('add-complaint-btn').onclick = addComplaint;
            document.getElementById('add-sla-btn').onclick = addSlaRecord;
            document.getElementById('add-issue-btn').onclick = addIssue;
            document.getElementById('add-info-btn').onclick = addInfoTambahan;
        };
        const addDisplayEventListeners = () => {
            document.body.onchange = (e) => {
                const target = e.target;
                if (target.id.endsWith('PeriodFilter')) {
                    const tabId = target.id.replace('PeriodFilter', '');
                    if (tabId === 'comp') complaintPeriodFilter = target.value;
                    if (tabId === 'sla') slaPeriodFilter = target.value;
                    if (tabId === 'issue') issuePeriodFilter = target.value;
                    if (tabId === 'infoTambahan') infoTambahanPeriodFilter = target.value;
                    renderAllTabs();
                }
                if (target.id.endsWith('BranchFilter')) {
                    const tabId = target.id.replace('BranchFilter', '');
                    if (tabId === 'comp') complaintBranchFilter = target.value;
                    if (tabId === 'sla') slaBranchFilter = target.value;
                    if (tabId === 'issue') issueBranchFilter = target.value;
                    if (tabId === 'infoTambahan') infoTambahanBranchFilter = target.value;
                    renderAllTabs();
                }
            };
            document.body.onclick = (e) => {
                const btn = e.target.closest('button');
                if (!btn || btn.disabled) return;
                const id = btn.id;
                if (id.startsWith('toggle-')) {
                    if (id.includes('komplain')) showComplaintsViz = !showComplaintsViz;
                    if (id.includes('sla')) showSlaViz = !showSlaViz;
                    if (id.includes('isu')) showIssuesViz = !showIssuesViz;
                    renderAllTabs();
                }
                const docId = btn.dataset.id;
                const type = btn.dataset.type;
                if (btn.classList.contains('delete-btn')) {
                    showConfirmation(`Anda yakin ingin menghapus item ini?`, () => deleteItem(`${type}s`, docId));
                } else if (btn.classList.contains('status-update-btn')) {
                    openStatusUpdateDialog(docId, type, btn.dataset.status, btn.dataset.subservice);
                } else if (btn.classList.contains('edit-btn')) {
                    if (type === 'infoTambahan') {
                        openInfoEditDialog(docId);
                    }
                }
            };
        };
        const getFormData = (formId, fields) => {
            const form = document.getElementById(formId);
            const data = {};
            for (const field of fields) {
                const element = form.querySelector(`[name="${field.name}"]`);
                if (element) {
                    if (element.type === 'number') data[field.key] = Number(element.value) || 0;
                    else if (element.required && !element.value) return null;
                    else data[field.key] = element.value;
                }
            }
            return data;
        };

        const addRecord = async (collectionName, data) => {
            if (!data) return showMessage("Harap lengkapi semua bidang yang wajib diisi.");
            try {
                data.reportingPeriod = formatReportingPeriod(data.periodStartDate, data.periodEndDate);
                await addDoc(collection(db, `artifacts/${appId}/public/data/${collectionName}`), data);
                showMessage("Data berhasil ditambahkan!");
                renderForms();
            } catch (e) { showMessage(`Gagal: ${e.message}`); }
        };

        const addComplaint = () => addRecord('complaints', getFormData('form-komplain', [{key: 'branch', name: 'branch', required: true}, {key: 'title', name: 'title', required: true}, {key: 'description', name: 'description', required: true}, {key: 'handling', name: 'handling'}, {key: 'status', name: 'status'}, {key: 'periodStartDate', name: 'periodStartDate', required: true}, {key: 'periodEndDate', name: 'periodEndDate', required: true}]));
        const addSlaRecord = () => {
            const baseData = getFormData('form-sla', [{key: 'branch', name: 'branch', required: true}, {key: 'periodStartDate', name: 'periodStartDate', required: true}, {key: 'periodEndDate', name: 'periodEndDate', required: true}]);
            if (!baseData) return showMessage("Harap lengkapi bidang wajib.");
            baseData.onClinic = getFormData('form-sla', [{key: 'totalLayanan', name: 'onClinic.totalLayanan'}, {key: 'jumlahSesuai', name: 'onClinic.jumlahSesuai'}, {key: 'jumlahTidakSesuai', name: 'onClinic.jumlahTidakSesuai'}, {key: 'penyebab', name: 'onClinic.penyebab'}, {key: 'penanganan', name: 'onClinic.penanganan'}, {key: 'status', name: 'onClinic.status'}]);
            baseData.onSite = getFormData('form-sla', [{key: 'totalLayanan', name: 'onSite.totalLayanan'}, {key: 'jumlahSesuai', name: 'onSite.jumlahSesuai'}, {key: 'jumlahTidakSesuai', name: 'onSite.jumlahTidakSesuai'}, {key: 'penyebab', name: 'onSite.penyebab'}, {key: 'penanganan', name: 'onSite.penanganan'}, {key: 'status', name: 'onSite.status'}]);
            addRecord('slaRecords', baseData);
        };
        const addIssue = () => addRecord('issues', getFormData('form-isu', [{key: 'branch', name: 'branch', required: true}, {key: 'issueDescription', name: 'issueDescription', required: true}, {key: 'supportRequest', name: 'supportRequest', required: true}, {key: 'status', name: 'status'}, {key: 'periodStartDate', name: 'periodStartDate', required: true}, {key: 'periodEndDate', name: 'periodEndDate', required: true}]));
        const addInfoTambahan = () => addRecord('infoTambahan', getFormData('form-infoTambahan', [{key: 'branch', name: 'branch', required: true}, {key: 'info', name: 'info', required: true}, {key: 'periodStartDate', name: 'periodStartDate', required: true}, {key: 'periodEndDate', name: 'periodEndDate', required: true}]));

        const deleteItem = async (collectionName, id) => {
            try { 
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id)); 
                showMessage("Item berhasil dihapus."); 
            }
            catch (e) { showMessage(`Gagal menghapus: ${e.message}`); }
        };
        const openStatusUpdateDialog = (id, type, currentStatus, subService) => {
            statusUpdateSelect.innerHTML = statusOptions.map(opt => `<option value="${opt}" ${opt === currentStatus ? 'selected' : ''}>${opt}</option>`).join('');
            statusUpdateCompletionDate.value = formatDate(new Date());
            statusUpdateSelect.onchange = () => statusUpdateCompletionDateContainer.classList.toggle('hidden-dialog', statusUpdateSelect.value !== 'Selesai');
            statusUpdateSelect.onchange(); 
            const newBtn = statusUpdateConfirmBtn.cloneNode(true);
            statusUpdateConfirmBtn.parentNode.replaceChild(newBtn, statusUpdateConfirmBtn);
            statusUpdateConfirmBtn = newBtn;
            statusUpdateConfirmBtn.onclick = () => handleStatusUpdate(id, type, subService);
            showDialog(statusUpdateDialog);
        };
        const handleStatusUpdate = async (id, type, subService) => {
            const newStatus = statusUpdateSelect.value;
            const completionDate = newStatus === 'Selesai' ? statusUpdateCompletionDate.value : null;
            let collectionName, fieldsToUpdate;
            if (type === 'sla') {
                collectionName = 'slaRecords';
                const record = allSlaRecords.find(r => r.id === id);
                if (!record) return showMessage("Data SLA tidak ditemukan.");
                fieldsToUpdate = { ...record, [subService]: { ...record[subService], status: newStatus, completionDate } };
            } else {
                collectionName = `${type}s`;
                fieldsToUpdate = { status: newStatus, completionDate };
            }
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id), fieldsToUpdate);
                showMessage("Status berhasil diperbarui.");
            } catch (e) { showMessage(`Gagal memperbarui: ${e.message}`); }
            finally { hideDialog(statusUpdateDialog); }
        };

        const openInfoEditDialog = (docId) => {
            const infoRecord = allInfoTambahan.find(info => info.id === docId);
            if (!infoRecord) {
                showMessage("Info tidak ditemukan.");
                return;
            }
            infoEditField.value = infoRecord.info;
            
            const newBtn = infoEditConfirmBtn.cloneNode(true);
            infoEditConfirmBtn.parentNode.replaceChild(newBtn, infoEditConfirmBtn);
            infoEditConfirmBtn = newBtn;
            infoEditConfirmBtn.onclick = () => handleInfoUpdate(docId);
            
            showDialog(infoEditDialog);
        };
        
        const handleInfoUpdate = async (docId) => {
            const newInfo = infoEditField.value;
            if (!newInfo) {
                showMessage("Info tidak boleh kosong.");
                return;
            }
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/infoTambahans`, docId), {
                    info: newInfo
                });
                showMessage("Info berhasil diperbarui.");
            } catch (e) {
                showMessage(`Gagal memperbarui info: ${e.message}`);
            } finally {
                hideDialog(infoEditDialog);
            }
        };

        const handleExportAllToExcel = () => {
            const dataSets = {
                Komplain: { data: allComplaints, filter: complaintPeriodFilter, branchFilter: complaintBranchFilter, headers: ['Cabang', 'Periode', 'Judul', 'Deskripsi', 'Penanganan', 'Status', 'Tgl Selesai'], renderer: c => `<td>${c.branch||''}</td><td>${c.reportingPeriod||''}</td><td>${c.title||''}</td><td>${c.description||''}</td><td>${c.handling||''}</td><td>${c.status||''}</td><td>${c.completionDate||''}</td>`},
                SLA: { data: allSlaRecords, filter: slaPeriodFilter, branchFilter: slaBranchFilter, headers: ['Cabang', 'Periode', 'On Clinic Total', 'On Clinic Sesuai', 'On Clinic Tdk Sesuai', 'On Clinic Penyebab', 'On Clinic Penanganan', 'On Clinic Status', 'On Site Total', 'On Site Sesuai', 'On Site Tdk Sesuai', 'On Site Penyebab', 'On Site Penanganan', 'On Site Status'], renderer: s => `<td>${s.branch||''}</td><td>${s.reportingPeriod||''}</td><td>${s.onClinic?.totalLayanan||0}</td><td>${s.onClinic?.jumlahSesuai||0}</td><td>${s.onClinic?.jumlahTidakSesuai||0}</td><td>${s.onClinic?.penyebab||''}</td><td>${s.onClinic?.penanganan||''}</td><td>${s.onClinic?.status||''}</td><td>${s.onSite?.totalLayanan||0}</td><td>${s.onSite?.jumlahSesuai||0}</td><td>${s.onSite?.jumlahTidakSesuai||0}</td><td>${s.onSite?.penyebab||''}</td><td>${s.onSite?.penanganan||''}</td><td>${s.onSite?.status||''}</td>`},
                Isu: { data: allIssues, filter: issuePeriodFilter, branchFilter: issueBranchFilter, headers: ['Cabang', 'Periode', 'Deskripsi', 'Dukungan', 'Status', 'Tgl Selesai'], renderer: i => `<td>${i.branch||''}</td><td>${i.reportingPeriod||''}</td><td>${i.issueDescription||''}</td><td>${i.supportRequest||''}</td><td>${i.status||''}</td><td>${i.completionDate||''}</td>`},
                Info: { data: allInfoTambahan, filter: infoTambahanPeriodFilter, branchFilter: infoTambahanBranchFilter, headers: ['Cabang', 'Periode', 'Info'], renderer: info => `<td>${info.branch||''}</td><td>${info.reportingPeriod||''}</td><td>${(info.info||'').replace(/\n/g, '<br/>')}</td>`},
            };
            let tableHtml = '';
            for (const key in dataSets) {
                const { data, filter, branchFilter, headers, renderer } = dataSets[key];
                let filteredData = data;
                if (filter !== 'Semua Periode') filteredData = filteredData.filter(d => d.reportingPeriod === filter);
                if (branchFilter !== 'Semua Cabang') filteredData = filteredData.filter(d => d.branch === branchFilter);
                
                if (filteredData.length > 0) {
                    tableHtml += `<h2>Laporan ${key} - Periode: ${filter}, Cabang: ${branchFilter}</h2><table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${filteredData.map(d => `<tr>${renderer(d)}</tr>`).join('')}</tbody></table><br/>`;
                }
            }
            if (!tableHtml) return showMessage("Tidak ada data untuk diekspor.");
            const fullHtml = `<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="utf-8"/><style>table,th,td{border:1px solid black;border-collapse:collapse}th,td{padding:5px}th{background-color:#f2f2f2}</style></head><body>${tableHtml}</body></html>`;
            const blob = new Blob([fullHtml], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MyReport_${formatDate(new Date())}.xls`;
            link.click();
        };
        const setupFirestoreListeners = () => {
            firestoreUnsubscribes.forEach(unsub => unsub());
            firestoreUnsubscribes = [];
            const collections = {
                complaints: (data) => allComplaints = data,
                slaRecords: (data) => allSlaRecords = data,
                issues: (data) => allIssues = data,
                infoTambahan: (data) => allInfoTambahan = data,
            };
            for (const name in collections) {
                const q = query(collection(db, `artifacts/${appId}/public/data/${name}`));
                const unsub = onSnapshot(q, (snapshot) => {
                    collections[name](snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    renderAllTabs();
                }, (error) => { console.error(`Error fetching ${name}:`, error); showMessage(`Gagal memuat data ${name}.`); });
                firestoreUnsubscribes.push(unsub);
            }
        };

        const handleGoogleSignIn = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google Sign-In Error:", error);
                showMessage(`Login Gagal: ${error.code}`);
            });
        };
        
        const switchView = (view) => {
            currentView = view;
            const inputColumn = document.getElementById('input-column');
            const displayColumn = document.getElementById('display-column');
            const viewInputBtn = document.getElementById('view-input-btn');
            const viewDashboardBtn = document.getElementById('view-dashboard-btn');

            if (view === 'input') {
                inputColumn.classList.remove('hidden');
                displayColumn.classList.remove('lg:col-span-3');
                displayColumn.classList.add('lg:col-span-2');

                viewInputBtn.classList.add('bg-[#154887]', 'text-[#fefdfc]');
                viewInputBtn.classList.remove('text-[#154887]', 'hover:bg-[#e9d9b0]');
                viewDashboardBtn.classList.remove('bg-[#154887]', 'text-[#fefdfc]');
                viewDashboardBtn.classList.add('text-[#154887]', 'hover:bg-[#e9d9b0]');
            } else { // 'dashboard' view
                inputColumn.classList.add('hidden');
                displayColumn.classList.remove('lg:col-span-2');
                displayColumn.classList.add('lg:col-span-3');

                viewDashboardBtn.classList.add('bg-[#154887]', 'text-[#fefdfc]');
                viewDashboardBtn.classList.remove('text-[#154887]', 'hover:bg-[#e9d9b0]');
                viewInputBtn.classList.remove('bg-[#154887]', 'text-[#fefdfc]');
                viewInputBtn.classList.add('text-[#154887]', 'hover:bg-[#e9d9b0]');
            }
            renderAllTabs(); // Re-render to resize charts
        };
        
        const init = async () => {
            // --- ▼▼▼ GANTI DENGAN KONFIGURASI FIREBASE ANDA ▼▼▼ ---
            // Salin konfigurasi proyek Firebase Anda di sini.
            const firebaseConfigPlaceholder = {
                apiKey: "AIzaSyCRNTafMklQKHd4M25nAcs-ZLTK0UxvuGE",
                authDomain: "myreport-9e7e6.firebaseapp.com",
                projectId: "myreport-9e7e6",
                storageBucket: "myreport-9e7e6.firebasestorage.app",
                messagingSenderId: "1006939537070",
                appId: "1:1006939537070:web:d1863128a9507491b0b73f"
            };
            // --- ▲▲▲ AKHIR DARI BAGIAN KONFIGURASI ▲▲▲ ---

            // --- ▼▼▼ DAFTAR EMAIL YANG DIIZINKAN BISA DIAKSES DI SINI ▼▼▼ ---
            const authorizedEmails = [
                "muhherman226@gmail.com",
                "dr.dwikartikasarimmr@gmail.com",
                "ekonovidianto7@gmail.com",
                "fati.imahss@gmail.com",
                "kadeklestary@gmail.com",
                "pekaktemplar@gmail.com",
                "tmcsemarang1@gmail.com"
                // Tambahkan alamat email lain di sini jika perlu
            ];
             // --- ▲▲▲ AKHIR DARI DAFTAR EMAIL ▲▲▲ ---

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigPlaceholder;
            
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) { 
                errorMessage.textContent = "Konfigurasi Firebase tidak valid. Harap ganti nilai placeholder di dalam kode dengan kredensial proyek Firebase Anda."; 
                showDialog(errorDisplay); 
                return; 
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');
                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.style.display = 'none';
                    if (user && !user.isAnonymous) {
                        // Cek apakah email pengguna ada di dalam daftar yang diizinkan
                        if (authorizedEmails.includes(user.email)) {
                            userId = user.uid;
                            userName.textContent = user.displayName || 'Pengguna';
                            userEmail.textContent = user.email || '';
                            if (user.photoURL) userPhoto.src = user.photoURL;
                            hideDialog(loginScreen);
                            mainContent.classList.remove('hidden');
                            userInfo.style.display = 'flex';
                            setupFirestoreListeners();
                            renderForms();
                            addDisplayEventListeners();
                        } else {
                            // Jika email tidak terdaftar, tampilkan error dan logout
                            errorMessage.textContent = `Akses Ditolak. Email Anda (${user.email}) tidak terdaftar.`;
                            showDialog(errorDisplay);
                            mainContent.classList.add('hidden');
                            userInfo.style.display = 'none';
                            signOut(auth); // Langsung logout pengguna
                        }
                    } else {
                        userId = null;
                        mainContent.classList.add('hidden');
                        userInfo.style.display = 'none';
                        showDialog(loginScreen);
                        firestoreUnsubscribes.forEach(unsub => unsub());
                        firestoreUnsubscribes = [];
                    }
                });
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Custom token sign-in failed, falling back to manual sign-in.", error);
                    }
                } else {
                     loadingIndicator.style.display = 'none';
                     showDialog(loginScreen);
                }
            } catch (e) {
                loadingIndicator.style.display = 'none';
                errorMessage.textContent = `Gagal inisialisasi: ${e.message}`;
                showDialog(errorDisplay);
            }
            document.getElementById('tabs-container').onclick = (e) => {
                if (e.target.matches('.tab-btn')) {
                    activeTab = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.toggle('bg-[#154887]', btn === e.target);
                        btn.classList.toggle('text-[#fefdfc]', btn === e.target);
                        btn.classList.toggle('shadow-md', btn === e.target);
                        btn.classList.toggle('text-[#154887]', btn !== e.target);
                        btn.classList.toggle('hover:bg-[#e9d9b0]', btn !== e.target);
                    });
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden-dialog'));
                    document.getElementById(`form-${activeTab}`).classList.remove('hidden-dialog');
                    document.getElementById(`display-${activeTab}`).classList.remove('hidden-dialog');
                }
            };
            document.getElementById('view-input-btn').onclick = () => switchView('input');
            document.getElementById('view-dashboard-btn').onclick = () => switchView('dashboard');
            messageDialogOkBtn.onclick = () => hideDialog(messageDialog);
            confirmationDialogCancelBtn.onclick = () => hideDialog(confirmationDialog);
            statusUpdateCancelBtn.onclick = () => hideDialog(statusUpdateDialog);
            infoEditCancelBtn.onclick = () => hideDialog(infoEditDialog);
            signOutBtn.onclick = () => signOut(auth);
            googleSignInBtn.onclick = handleGoogleSignIn;
            document.getElementById('export-excel-btn').onclick = handleExportAllToExcel;
        };

        init();
    </script>
</body>
</html>

